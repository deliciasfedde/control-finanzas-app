<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">

 <meta charset="UTF-8">

  <link rel="manifest" href="<?= ScriptApp.getService().getUrl(); ?>?page=manifest.json">
  <meta name="theme-color" content="#f50782">

<title>Index con WhatsApp</title>
<base target="_top">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">

<!-- Streaming HLS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<style>
/* Aqu√≠ siguen tus estilos */

body {
  font-family: var(--tipografia, 'Segoe UI'), sans-serif;
  background-color: var(--fondo, #000);
  color: var(--texto, #00f7ff);
  text-align: center;
  margin: 10px;

  /* üëá clave para ocupar toda la pantalla */
  min-height: 100vh;
  margin: 0;


    /* Para que las texturas se vean bien */
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
}

/* Bloqueo total de zoom, permitiendo scroll vertical */
html, body {
  max-width: 100%;
  overflow-x: hidden;
  touch-action: pan-y;
  -ms-touch-action: pan-y;
}


h1 {
  font-size: 100px;
  font-weight: bold;
  background: var(--tituloGradient, linear-gradient(to right,#9ffccc, #9ffccc));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}


/* Tarjetas */
.card {
  position: relative;
  background-color: var(--cardFondo, #0e0d12); /* fondo oscuro */
  border-radius: 40px;
  padding: 50px;
  margin: 50px auto;
  max-width: 900px;
  z-index: 1; /* para que el contenido quede encima */
}

.card::before {
  content: "";
  position: absolute;
  inset: 0; /* cubrir todo */
  border-radius: inherit; /* üëà respeta el mismo redondeo */
  padding: 6px; /* grosor del borde */
  background: linear-gradient(100deg, #6207f5, #f50782);
  -webkit-mask: 
    linear-gradient(#fff 0 0) content-box, 
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  z-index: -1;
}

.card h2 {
  color: var(--subtitulo, #7b00ff);
  font-size: 60px;
  font-weight: bold;
  font-family: var(--tipografia, 'Orbitron'), sans-serif;
}

/* Etiquetas */
label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
  font-size: 30px;
  color: #fff;
  font-family: 'Orbitron', sans-serif;
}

/* Campos */
select, input[type="number"], input[type="file"], input[type="text"] {
  width: 85%;
  max-width: 800px;
  background-color: var(--inputFondo, #d5f5e6); /* usa variable, fallback celeste */
  color: #080808;                /* texto negro por defecto */
  font-family: 'Orbitron', sans-serif;
  font-size: 40px;
  font-weight: 700;
  padding: 6px 8px;
  margin: 20px auto;
  border: 10px solid #112b38;
  border-radius: 20px;
  box-shadow:
    0 0 10px #3ef0a0,
    inset 0 0 6px #3ef0a0,
    inset 0 0 3px #3ef0a0;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  overflow: hidden;
  white-space: normal;  
  word-wrap: break-word;
  line-height: 1.2;
}

/* Botones */
button {
  margin: 12px 10px;
  padding: 18px 28px;
  font-size: 30px;
  font-weight: bold;
  background: var(--botones, linear-gradient(45deg, #bfff00, #bfff00, #bfff00));
  color: var(--textoBoton, #000);
  border: none;
  border-radius: 20px;
  cursor: pointer;
  box-shadow: 0 0 12px #fdfff2;
  font-family: var(--tipografia, 'Orbitron'), sans-serif;
}
button:hover { opacity: 0.85; }
/* üé• Ajuste del video LED para ocupar completamente la pantalla LED */
#indicadores {
  position: relative !important;
  width: 100% !important;
  height: 230px !important; /* Altura normal cuando es texto */
  padding: 0 !important;
  overflow: hidden !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  background: var(--ledFondo, repeating-linear-gradient(90deg, #000, #000 10px, #111 10px, #111 20px)) !important;
  transition: height 0.4s ease-in-out !important; /* Suave transici√≥n */
  box-shadow: 0 0 25px var(--ledSombra, rgba(255,255,255,0.6)) !important;
  border-radius: 0 !important;
}

/* Cuando la pantalla LED tiene video, se agranda autom√°ticamente */
#indicadores.modo-video {
  height: 350px !important; /* üîπ Altura deseada del LED con video */
  background: #000 !important; /* Fondea negro cuando hay video */
}

/* === Estilo del texto LED === */
#indicadores span {
  display: inline-block !important;
  padding-left: 20% !important;
  animation: scroll 12s linear infinite, blink 1s infinite alternate !important;
  font-family: var(--tipografiaPantalla, 'VT323'), monospace !important;
  font-size: var(--ledSpanFontSize, 90px) !important;
  font-weight: 900 !important;
  letter-spacing: 2px !important;
  color: var(--ledTexto, #ddfacd) !important;
  text-shadow: 0 0 4px var(--ledBrilloTexto, #ddfacd) !important;
}

/* üîÑ Animaciones del texto LED */
@keyframes scroll {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}
@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.75; }
  100% { opacity: 1; }
}

/* Contenedor del video LED */
#videoLED-container {
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important; /* üîπ Siempre llena la pantalla LED completa */
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  overflow: hidden !important;
  border-radius: 0 !important;
  background: #000 !important;
}

/* El video se ajusta autom√°ticamente para llenar todo el LED */
#videoLED {
  width: 100% !important;
  height: 100% !important;
  min-width: 100% !important;
  min-height: 100% !important;
  object-fit: cover !important;  /* üîπ Llenar todo el √°rea sin deformar */
  object-position: center center !important;
  border: none !important;
  cursor: pointer !important;
  z-index: 1 !important;
}

/* Texto "Pincha aqu√≠ para m√°s informaci√≥n" centrado dentro del video */
#textoClickVideo {
  position: absolute !important;
  bottom: 0.5% !important; /* üîπ un poco m√°s abajo */
  left: 50% !important;
  transform: translateX(-50%) !important;
  width: 90% !important;
  text-align: center !important;
  background: none !important; /* üîπ sin cuadro negro */
  color: #ffffff !important;
  font-family: 'Orbitron', sans-serif !important;
  font-size: 12px !important;
  font-weight: bold !important;
  border-radius: 10px !important;
  padding: 6px 10px !important;
  animation: scrollVideoText 25s linear infinite !important;
  white-space: nowrap !important;
  z-index: 2 !important;
  cursor: pointer !important;
}

/* Ajuste en celulares */
@media (max-width: 768px) {
  #indicadores.modo-video {
    height: 350px !important; /* üîπ Misma altura en m√≥vil */
  }

  #textoClickVideo {
    font-size: 12px !important;
  }

  #indicadores span {
    font-size: 60px !important;
  }
}/* üñºÔ∏è Im√°genes/GIFs dentro del LED */
#indicadores span img {
  max-height: 130px;     /* LED es 140px de alto, evita cortes */
  max-width: 60vw;       /* por si la imagen es muy ancha */
  vertical-align: middle;
  border-radius: 12px;
  margin-left: 10px;     /* respiro respecto al texto/firma */
  box-shadow: 0 0 10px rgba(255,255,255,0.25);
}

@media (max-width: 768px) {
  #indicadores span img {
    max-height: 90px;
    max-width: 80vw;
  }
}

/* Pantallas chicas (celulares) */
@media (max-width: 768px) {
  #indicadores {
    width: 100%;
    min-width: auto;   /* üëà elimina el m√≠nimo en m√≥viles */
    max-width: 100%;   /* üëà se adapta al ancho del celular */
    font-size: 24px;   /* opcional: texto m√°s peque√±o para que no se corte */
  }

  #indicadores span {
    font-size: 48px;   /* üëà LED m√°s chico y legible en m√≥viles */
  }
}

/* Alerta */
#alertaPersonalizada {
  position: fixed;
  top: 30%;
  left: 50%;
  transform: translateX(-0%);
  background: linear-gradient(135deg, #00ffcc, #39ff14);
  color: #000;
  font-size: 28px;
  font-weight: bold;
  padding: 22px 36px;
  border-radius: 20px;
  box-shadow: 0 0 20px #00ffcc;
  display: none;
  z-index: 9999;
}

/* Botones al final */
.footer-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 30px;
}
@media (max-width: 768px) {
  body {
    font-size: 1.8rem; /* üëà m√°s grande en m√≥viles */
    padding: 20px;      /* üëà menos espacio pero m√°s c√≥modo visualmente */
  }

  h1 {
    font-size: 48px;    /* üëà tama√±o grande pero manejable en pantallas peque√±as */
  }

  input, button {
    font-size: 1.4rem;  /* üëà agranda campos y botones */
  }
}
#whatsapp-btn {
  position: relative;
  top: 10px;   /* lo bajas hasta que no tape nada */
  left: 20px;   /* pegado a la izquierda */
  cursor: pointer;
  z-index: 9999;
  text-align: center;
 
}

#whatsapp-btn img {
  width: 65px;
  height: 65px;
  filter: drop-shadow(0 0 8px #00ff00);
  transition: transform 0.2s ease-in-out;
}
#whatsapp-btn img:hover { transform: scale(1.1); }
.whatsapp-text {
  font-family: 'Orbitron', sans-serif;
  font-size: 28px; /* puedes ajustarlo */
  font-weight: bold;
  text-align: center;
  margin-top: 8px;
  margin-bottom: 20px;
  background: linear-gradient(to right, #00f7ff, #8000c8); /* degradado igual al t√≠tulo */
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.arrow {
  display: block;
  font-size: 28px;
  background: linear-gradient(to right, #00f7ff, #8000c8);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
  text-align: center;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}
.custom-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  justify-content: center;
  align-items: center;
  z-index: 99999;
}

.modal-content {
  background: black;
  border: 2px solid #00ffcc;
  color: #00ffcc;
  font-family: 'Orbitron', sans-serif;
  text-align: center;
  padding: 40px;
  box-shadow: 0 0 15px #00ffcc;
  border-radius: 30px;
   max-width: 500px;
  width: 90%;
}

.modal-content h2 {
  font-size: 50px;
  margin-bottom: 20px;
  font-family: 'Orbitron', sans-serif;
}

.modal-content button {
  display: block;
  width: 100%;
  margin: 10px 0;
  padding: 10px;
  background: black;
  color: #00ffcc;
  border: 1px solid #00ffcc;
  font-size: 40px;
  cursor: pointer;
  transition: background 0.3s;
  font-family: 'Orbitron', sans-serif;
}

.modal-content button:hover {
  background: #00ffcc;
  color: black;
}

/* Estilos calculadora */
#calc-container {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  margin-top: 20px;
}

#calc-container button {
  font-size: 100px;
  padding: 24px;
  border-radius: 12px;
  border: 1px solid #00ffcc;
  background: black;
  color: #00ffcc;
  cursor: pointer;
  transition: background 0.3s;
}
#calc-container button:hover {
  background: #00ffcc;
  color: black;
}

#calc-display {
  grid-column: span 5;
  background: #111;
  color: #0f0;
  font-family: 'Share Tech Mono', monospace;
  font-size: 40px;
  padding: 18px;
  border: 2px solid #00ffcc;
  border-radius: 12px;
  text-align: right;
}


.close-btn {
  position: absolute;
  top: 15px; right: 20px;
  font-size: 20px;
  color: #00ffcc;
  cursor: pointer;
}



.pantalla-gameboy {
  width: 750px;
  height: 250px;
  background-color: var(--pantallaGameboyFondo, #d5f5e6); /* üëà usa variable */
  color: #080808;                /* texto negro por defecto */
  font-family: 'Share Tech Mono', monospace; /* üëà estilo reloj digital */
  font-size: 45px;
  font-weight: 700;
  padding: 6px 8px;
  margin: 20px auto;
  border: 10px solid #112b38;
  border-radius: 32px;
  box-shadow:
    0 0 10px #3ef0a0,
    inset 0 0 6px #3ef0a0,
    inset 0 0 3px #3ef0a0;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  overflow: hidden;
  white-space: normal;  
  word-wrap: break-word;
  line-height: 1.2;
}

.pantalla-mes {
  color: #7b00ff;  
  font-family: 'Orbitron', sans-serif;
  font-size: 45px;
  font-weight: 700;
}

.pantalla-item {
  color: #961148;
  font-family: 'Orbitron', sans-serif;
  font-size: 30px;
  font-weight: 700;
}

/* Ocultar scrollbar en todos los navegadores */
.pantalla-gameboy::-webkit-scrollbar { 
  display: none; /* Chrome, Safari, Edge */
}
.pantalla-gameboy {
  -ms-overflow-style: none;  /* IE y Edge */
  scrollbar-width: none;     /* Firefox */
}

#videoContainer {
  display: none;
width: 851px;
height: 315px;
margin: 40px auto;
align-items: center;
justify-content: center;
overflow: hidden;
border-radius: 30px;
position: relative;
}


video {
width: 100%;
height: 100%;
border-radius: 30px;
object-fit: cover;
}


/* üéõÔ∏è Bot√≥n mute flotante */
.btn-mute {
position: absolute;
bottom: 15px;
right: 15px;
background: rgba(0, 0, 0, 0.7);
border: none;
color: white;
font-size: 20px;
padding: 8px 12px;
border-radius: 50%;
cursor: pointer;
z-index: 10;
transition: background 0.3s ease;
}

.btn-mute:hover {
  background: rgba(0, 0, 0, 0.9);
}

/* Bot√≥n con el MISMO dise√±o del selector "Mes" + transparencia en reposo */
.btn-calculadora {
  width: 85%;
  max-width: 800px;
  border: 10px solid #112b38;
  border-radius: 20px;
  box-shadow:
    0 0 10px #3ef0a0,
    inset 0 0 6px #3ef0a0,
    inset 0 0 3px #3ef0a0;

  font-family: 'Orbitron', sans-serif;
  color: #080808;
  background-color: var(--inputFondo, #bfff00); /* üîπ fondo fijo */
  
  min-height: 84px;
  padding: 0 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 20px auto;
  text-align: center;
  box-sizing: border-box;
  cursor: pointer;
  white-space: nowrap;
}

.btn-calculadora__label {
  font-size: 34px;
  font-weight: 700;
}

/* Efecto m√°quina de escribir en la pantalla Gameboy */
#contenidoItem span.typing {
  display: inline-block;
  white-space: pre-wrap;
  overflow: hidden;
  border-right: 3px solid #112b38; /* cursor parpadeante */
  animation: caret 0.7s steps(1) infinite;
}

@keyframes caret {
  50% { border-color: transparent; }
}

/* üîπ Pantalla LED Resumen con brillo superior e inferior suave */
#indicadores-resumen {
  width: 100%;
  height: 70px; /* franja delgada */
  overflow: hidden;
  white-space: nowrap;
  background: var(--ledFondo, repeating-linear-gradient(90deg, #000, #000 10px, #111 10px, #111 20px));
  border-radius: 18px;
  padding: 15px;
  font-size: var(--ledFontSize, 28px);
  font-weight: bold;
  color: var(--ledTexto, #ffffff);
  text-shadow: 0 0 8px var(--ledBrilloTexto, #ffffff);
  margin: 0 auto;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: none;
  border: none;
}

/* ‚ú® Contornos luminosos solo arriba y abajo (suaves) */
#indicadores-resumen::before,
#indicadores-resumen::after {
  content: "";
  position: absolute;
  left: 0;
  width: 100%;
  height: 4px; /* grosor del brillo */
  background: linear-gradient(
    90deg,
    rgba(255, 0, 255, 0.35) 0%,
    rgba(0, 255, 255, 0.55) 50%,
    rgba(255, 255, 0, 0.35) 100%
  );
  filter: blur(6px);
  animation: brilloHorizontal 3s ease-in-out infinite alternate;
}

#indicadores-resumen::before {
  top: 0;
}

#indicadores-resumen::after {
  bottom: 0;
}

/* üîπ Texto del LED resumen general */
#indicadores-resumen span {
  display: inline-block;
  padding-left: 20%;
  animation: scroll 16s linear infinite; /* ‚úÖ Se mantiene solo el desplazamiento */
  font-family: var(--tipografiaPantalla, 'VT323'), monospace;
  font-size: var(--ledSpanFontSize, 70px);
  font-weight: 900;
  letter-spacing: 2px;
}

/* üå∏ Texto principal (resumen: hora, fecha, ingresos, egresos) */
#indicadores-resumen span.texto-resumen {
  color: #ff006a; /* Rosa LED brillante */
  text-shadow:
    0 0 4px rgba(255, 0, 106, 0.6),
    0 0 10px rgba(255, 0, 106, 0.3);
  animation: none !important; /* üö´ Sin parpadeo */
}

/* ü§ç Texto del recordatorio (blanco, sin brillo ni parpadeo) */
#indicadores-resumen span.texto-recordatorio {
  color: #ffffff !important; /* Blanco puro */
  text-shadow: none !important;
  font-weight: bold;
  animation: none !important;
  margin-left: 8px;
}

/* üî• Animaci√≥n suave del brillo horizontal */
@keyframes brilloHorizontal {
  from {
    opacity: 0.6;
    filter: blur(6px);
  }
  to {
    opacity: 1;
    filter: blur(10px);
  }
}




/* üîπ Contenedor del bot√≥n debajo del LED Resumen */
.contenedor-boton {
  text-align: center;
  margin-top: 8px; /* distancia entre el LED y el bot√≥n */
}

/* üîπ Contenedor del bot√≥n debajo del LED Resumen */
.contenedor-boton {
  text-align: center;
  margin-top: 10px;
}

/* üîπ Bot√≥n con borde degradado redondeado RGB */
#boton-aplicaciones {
  position: relative;
  display: inline-block;
  padding: 18px 50px;
  font-family: 'Orbitron', sans-serif;
  font-size: 40px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: #ddfacd;
  background: #000; /* fondo oscuro para contraste */
  border: none; /* quitamos el borde original */
  border-radius: 50px; /* esquinas redondeadas */
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.3s ease, opacity 0.3s ease;
  overflow: hidden;
  z-index: 0;
}

/* ‚ú® Borde degradado falso (perfectamente redondeado) */
#boton-aplicaciones::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: inherit; /* üîπ sigue el mismo redondeo */
  padding: 3px; /* grosor del borde */
  background: linear-gradient(90deg, #00ffff, #ff00ff, #ffff00);
  -webkit-mask: 
    linear-gradient(#fff 0 0) content-box, 
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  z-index: -1;
}

/* ‚ú® Efecto hover */
#boton-aplicaciones:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 25px rgba(255, 255, 255, 0.6);
  opacity: 0.95;
}

/* üîπ Versi√≥n adaptada para celulares */
@media (max-width: 768px) {
  #boton-aplicaciones {
    width: 90%;
    font-size: 42px;
    padding: 25px 0;
    border-radius: 60px;
  }
}

/* ‚ú® Animaci√≥n de aparici√≥n √©pica para la GameBoy */
.animarEntrada {
  animation: aparecer 0.7s cubic-bezier(.2,.9,.2,1) forwards;
  opacity: 0;
  transform: scale(0.96);
}

@keyframes aparecer {
  from {
    opacity: 0;
    transform: scale(0.96) translateY(6px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

/* Tipograf√≠a y colores estilizados GameBoy üíúüíô */
.gb-texto {
  font-family: 'Orbitron', sans-serif;
  font-size: 32px;
  line-height: 1.4;
  text-align: center;
  color: #000000;
}

.gb-mes {
  font-size: 40px;
  font-weight: bold;
  color: #7e00fc; /* morado */
  margin-bottom: 5px;
}

.gb-item {
  font-size: 40px;
  font-weight: bold;
  color: #f70063; /* fuxia oscuro */
  margin-bottom: 8px;
}

.gb-datos {
  font-size: 36px;
  color: #000000;
}

/* Texto "Pincha aqu√≠..." dentro del LED */
#textoClickImagen {
  position: absolute !important;
  bottom: 15px !important;
  left: 0 !important;
  width: 100% !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  pointer-events: auto !important;
  z-index: 9999 !important;
  text-align: left !important;
}

#scrollTextImagen {
  display: inline-block !important;
  padding-left: 100% !important; /* inicia fuera a la derecha */
  font-family: 'Orbitron', sans-serif !important;
  font-size: 22px !important;
  font-weight: bold !important;
  color: inherit !important;
  animation: scrollTextImagen 18s linear infinite !important;
  will-change: transform;
  user-select: none;
}

@keyframes scrollTextImagen {
  0% { transform: translateX(100%); }   /* üîπ Arranca desde la derecha */
  100% { transform: translateX(-100%); } /* üîπ Termina a la izquierda */
}


   .alerta-futurista {
    position: fixed;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #0f0f0f;
    color: #00ffcc;
    padding: 25px 50px;
    border: 2px solid #00ffcc;
    border-radius: 30px;
    font-family: 'Press Start 2P', monospace;
    font-size: 42px;
    text-align: center;
    z-index: 9999;
    box-shadow: 0 0 12px #00ffcc;
    animation: fadeOutFuturista 2s forwards;}
@keyframes fadeOutFuturista {
    0% { opacity: 1;}
80% { opacity: 1;}
100% { opacity: 0; top: 10px;}


@keyframes scrollFbText {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}



</style>

<!-- üîë integraci√≥n de sistema de temas -->
<?!= include('themes'); ?>
<?!= include('ui'); ?>


</head>

  <body data-page="index">

    <iframe
    src="https://script.google.com/macros/s/AKfycbxBNeot8mKAILy8UsAIj-HSQz-p3CYPkyZkHs6p-LvnPBujFGqtgh9wetrt8UFZgcwMIA/exec"
    allow="camera; microphone"
  ></iframe>




<!-- Indicadores LED -->
 <div id="indicadores">
  <span id="ledContent">HOY SERA UN BUEN DIA</span>
</div>

<div id="indicadores-resumen">
  <span id="ledResumenContent">Cargando resumen...</span>
</div>
<!-- üõë Bot√≥n para detener/eliminar recordatorio activo -->
<div id="boton-detener-recordatorio" style="display:none; margin-top:10px;">
  <button onclick="eliminarRecordatorioActivo()" 
          style="font-family:'Orbitron',sans-serif; font-size:28px; padding:15px 30px; 
                 background:linear-gradient(45deg,#ff5252,#ff1744); color:white;
                 border:none; border-radius:18px; cursor:pointer; box-shadow:0 0 15px #ff1744;">
    üõë Detener Recordatorio
  </button>
</div>

<!-- üîπ Bot√≥n principal: ahora abre el modal de p√°ginas -->
<div class="contenedor-boton">
  <button id="boton-aplicaciones" onclick="abrirPaginas()">FUNCIONES EXTRAS</button>
</div>




<h1>CONTROL DE MIS FINANZAS</h1>
<!-- Registro Movimientos -->
<div class="card" style="margin-top: 50px;">

<!-- üî∏ Selector de transmisiones -->
<div id="selectorStreams" style="display:none; margin-top:20px;">
  <label for="streamSelect" style="color:white; font-family:'Orbitron',sans-serif; font-size:30px;">
    Selecciona una transmisi√≥n:
  </label>
  <select id="streamSelect"
          style="width:85%; max-width:800px; background-color:#d5f5e6; color:#000; font-family:'Orbitron',sans-serif; font-size:28px; font-weight:bold; padding:8px; border:10px solid #112b38; border-radius:20px; box-shadow:0 0 10px #3ef0a0; text-align:center;">
    <option value="">-- Selecciona un canal --</option>
  </select>
</div>




<!-- Contenedor de video dentro del card -->
<div id="videoContainer"
     style="display:none; width:851px; height:315px; margin:40px auto; align-items:center; justify-content:center; overflow:hidden; border-radius:30px; position:relative; background:black; box-shadow:0 0 25px rgba(255,255,255,0.6);">

  
  <!-- Video para archivos MP4 o similares -->
  <video id="videoPlayer" width="851" height="315" autoplay muted controls loop style="border-radius:30px; object-fit:cover; display:none;">
    <source id="videoSource" src="" type="video/mp4">
    Tu navegador no soporta el video.
  </video>

  <!-- Iframe para streams (YouTube, Twitch, Relay, etc.) -->
  <iframe id="iframePlayer"
          style="display:none; width:100%; height:100%; border:none; border-radius:30px;"
          allow="autoplay; encrypted-media; picture-in-picture"
          allowfullscreen>
  </iframe>
</div>

<!-- üîπ Script completo para transmisiones din√°micas con control de visibilidad -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const contenedor = document.getElementById("videoContainer");
  const video = document.getElementById("videoPlayer");
  const source = document.getElementById("videoSource");
  const iframe = document.getElementById("iframePlayer");
  const selector = document.getElementById("selectorStreams");
  const streamSelect = document.getElementById("streamSelect");

  // üü¢ Primero verificamos la visibilidad global del contenedor
  google.script.run.withSuccessHandler(visibilidad => {
    if (!visibilidad.visible) {
      if (selector) selector.style.display = "none";
      if (contenedor) contenedor.style.display = "none";
      console.log("üîí Contenedor oculto por reglas globales en D2");
      return;
    }

    // Si el contenedor es visible ‚Üí cargar lista de transmisiones
    google.script.run.withSuccessHandler(list => {
      if (!list || list.length === 0) {
        console.warn("‚ö†Ô∏è No hay transmisiones disponibles para este usuario.");
        return;
      }

      selector.style.display = "block";
      contenedor.style.display = "none";

      // Llenar el selector con nombres desde la hoja
      list.forEach((item, index) => {
        const opt = document.createElement("option");
        opt.value = item.url;
        opt.textContent = item.name || `Canal ${index + 1}`;
        streamSelect.appendChild(opt);
      });

     // üü¢ Recuperar √∫ltima selecci√≥n guardada (y reproducir autom√°ticamente)
const lastSelected = localStorage.getItem("ultimoCanalSeleccionado");

// ‚úÖ Si estamos restaurando pausa desde TIEMPO DE PAUSA, NO hacemos autoplay aqu√≠.
// (La restauraci√≥n se encarga de seleccionar el video y aplicar currentTime)
if (localStorage.getItem("forzarRestauracionPausa") === "true") {
  console.log("‚õî Autoplay bloqueado por restauraci√≥n de pausa");
} else {

  

// üõë BLOQUEO DEFINITIVO DE AUTOPLAY SI EXISTE TIEMPO DE PAUSA
const hayPausaPendiente =
  localStorage.getItem("forzarRestauracionPausa") === "true";

// Si hay pausa pendiente, NO ejecutar ning√∫n autoplay
if (hayPausaPendiente) {
  console.log("‚õî Autoplay bloqueado por TIEMPO DE PAUSA pendiente");
  return; // üî¥ CORTA AQU√ç el flujo
}


// ‚ñ∂ Autoplay normal SOLO cuando no hay pausa pendiente



  // Si hay un √∫ltimo canal guardado, lo seleccionamos y reproducimos
  if (lastSelected && list.some(v => v.url === lastSelected)) {
    streamSelect.value = lastSelected;
    reproducirVideoSeleccionado(lastSelected);
  }
  // Si no hay uno guardado, reproducimos el primero disponible autom√°ticamente
  else if (list.length > 0) {
    const primerCanal = list[0].url;
    streamSelect.value = primerCanal;
    localStorage.setItem("ultimoCanalSeleccionado", primerCanal);
    reproducirVideoSeleccionado(primerCanal);
  }

}

// üîÅ Restaurar pausa desde TIEMPO DE PAUSA al entrar con sesi√≥n iniciada
try {
  // Evitamos ejecutar m√°s de una vez por carga de p√°gina
  if (!localStorage.getItem("pausaRestauradaEnEstaSesion")) {
    localStorage.setItem("pausaRestauradaEnEstaSesion", "true");

    // Solo si la funci√≥n existe (ya est√° definida m√°s arriba en tu script)
    if (typeof restaurarPausaDesdeSheet === "function") {
      restaurarPausaDesdeSheet();
    }
  }
} catch (e) {
  console.warn("No se pudo ejecutar restaurarPausaDesdeSheet al iniciar index:", e);
}


// üü£ Evento: cuando el usuario cambia de canal ‚Üí reproducir autom√°ticamente
streamSelect.addEventListener("change", () => {
  const url = streamSelect.value.trim();
  if (!url) {
    contenedor.style.display = "none";
    return;
  }
  localStorage.setItem("ultimoCanalSeleccionado", url);
  reproducirVideoSeleccionado(url);
});


      // Funci√≥n interna de reproducci√≥n
      function reproducirVideoSeleccionado(url) {
        video.style.display = "none";
        iframe.style.display = "none";

        const isVideo = url.match(/\.(mp4|mov|webm|ogg)$/i);
        const isStream =
    url.includes("youtube.com") ||
    url.includes("youtu.be") ||
    url.includes("facebook.com") ||
    url.includes("rudo.video") ||
    url.includes("relay") ||
    url.includes("stream") ||
    url.includes("player.twitch.tv") ||   // Twitch embed
    url.includes("twitch.tv") ||          // Twitch normal
    url.includes("drive.google.com");     // Google Drive

        if (isVideo) {
          source.src = url;
          video.load();
          video.play();
          video.style.display = "block";
          contenedor.style.display = "flex";
        } else if (isStream) {
          iframe.src = url;
          iframe.style.display = "block";
          contenedor.style.display = "flex";
        } else {
          contenedor.innerHTML = `<p style="color:white;">Tipo de enlace no reconocido: ${url}</p>`;
          contenedor.style.display = "flex";
        }
      }
    }).getVideoList(); // ‚Üê carga transmisiones individuales
  }).getContainerVisibility(); // ‚Üê aplica visibilidad global (D2)
});

// ============================================================
// üé¨ PAUSA PERSISTENTE (entre cierres de sesi√≥n y dispositivos)
// Guarda en hoja "TIEMPO DE PAUSA" del Sheet del usuario
// ============================================================

function getUrlActualContenedor() {
  // Ajusta aqu√≠ SOLO si t√∫ ya manejas una variable global con la URL actual.
  // Si tu l√≥gica actual ya tiene "urlActualVideo" o similar, √∫sala.
  // Fallback: usar src del videoPlayer.
  const videoPlayer = document.getElementById("videoPlayer");
  if (!videoPlayer) return "";

  // Si est√°s usando HLS, normalmente el src puede estar vac√≠o; en ese caso usa tu variable global si existe.
  // Aqu√≠ dejamos fallback seguro:
  return (videoPlayer.currentSrc || videoPlayer.src || "").trim();
}

function guardarPausaEnSheet() {
  try {
    const sheetId = (localStorage.getItem("sheetId") || "").trim();
    if (!sheetId) return;

    const videoPlayer = document.getElementById("videoPlayer");
    if (!videoPlayer) return;
    if (videoPlayer.style.display === "none") return;

    const url = getUrlActualContenedor();
    const tiempo = Number(videoPlayer.currentTime || 0);

    // Si no hay URL real, no guardamos
    if (!url) return;

    google.script.run.guardarTiempoPausa(sheetId, url, tiempo);
  } catch (e) {
    console.warn("guardarPausaEnSheet fall√≥:", e);
  }
}

function restaurarPausaDesdeSheet() {
  try {
    const sheetId = (localStorage.getItem("sheetId") || "").trim();
    if (!sheetId) return;

    // ‚úÖ Bloquea autoplay del selector mientras restauramos
    localStorage.setItem("forzarRestauracionPausa", "true");

    google.script.run.withSuccessHandler((data) => {
      try {
        if (!data || !data.url) {
          localStorage.removeItem("forzarRestauracionPausa");
          return;
        }

        const urlGuardada = String(data.url || "").trim();
        const tiempoGuardado = Number(data.tiempo || 0);

        // ‚úÖ 1) Intentar restaurar usando el selector (misma l√≥gica normal del contenedor)
        const streamSelect = document.getElementById("streamSelect");
        const existeEnSelect =
          streamSelect &&
          Array.from(streamSelect.options).some(o => (o.value || "").trim() === urlGuardada);

        if (existeEnSelect) {
          streamSelect.value = urlGuardada;
          streamSelect.dispatchEvent(new Event("change"));
        } else {
          // ‚úÖ 2) Fallback: reproducir directo (MP4/HLS) con tu funci√≥n existente
          reproducirVideo(urlGuardada);
        }

        const videoPlayer = document.getElementById("videoPlayer");
        if (!videoPlayer) {
          localStorage.removeItem("forzarRestauracionPausa");
          return;
        }

        const onMeta = () => {
          try {
            videoPlayer.currentTime = Math.max(0, tiempoGuardado || 0);
            videoPlayer.pause(); // ‚úÖ queda pausado al entrar
          } catch (e) {}
          videoPlayer.removeEventListener("loadedmetadata", onMeta);
          localStorage.removeItem("forzarRestauracionPausa");
        };

        if (videoPlayer.readyState >= 1) onMeta();
        else videoPlayer.addEventListener("loadedmetadata", onMeta);

      } catch (e) {
        localStorage.removeItem("forzarRestauracionPausa");
        console.warn("Error restaurando pausa:", e);
      }
    }).obtenerTiempoPausa(sheetId);

  } catch (e) {
    console.warn("restaurarPausaDesdeSheet fall√≥:", e);
  }
}

// ‚úÖ Guardar al pausar + al ocultar + antes de salir
document.addEventListener("DOMContentLoaded", () => {
  const videoPlayer = document.getElementById("videoPlayer");
  if (videoPlayer) {
    // (detalle m√≠nimo) evita duplicar listeners si por alguna raz√≥n este bloque se pega 2 veces
    videoPlayer.removeEventListener("pause", guardarPausaEnSheet);
    videoPlayer.addEventListener("pause", guardarPausaEnSheet);
  }

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) guardarPausaEnSheet();
  });

  window.addEventListener("beforeunload", guardarPausaEnSheet);

  // ‚úÖ restaurar una sola vez al entrar
  restaurarPausaDesdeSheet();
});

</script>



  <div id="logoContainer" 
     style="display:none; width:851px; height:315px; margin:40px auto; 
            align-items:center; justify-content:center;">
  <img id="logo" src="URL_DEL_LOGO" alt="Logo"
       style="width:80%; height:80%; object-fit:cover; clip-path: inset(0 round 30px); box-shadow:0 0 15px rgba(0,0,0,0.5);">
</div>

  <h2>Registro Movimientos de Dineros</h2>
  <label for="mesSelect">Mes:</label>
  <select id="mesSelect"></select>

  <label for="itemSelect">√çtem del mes:</label>
<select id="itemSelect">

  <option value="ITEM">√çtem</option>

</select>

 <h3 style="color:#fff; font-family:'Orbitron', sans-serif; font-size:30px; margin-bottom:15px; text-shadow:0 0 8px #7b00ff;">
    Resumen Dineros Mensual Por Item
  </h3>
<!-- Pantalla estilo Gameboy para detalle del √≠tem -->
<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; margin-top:20px;">
  <div class="pantalla-gameboy" id="pantallaItem">
    <div id="contenidoItem"></div>
  </div>

  <!-- Bot√≥n Calculadora debajo de la pantalla Gameboy -->
<div style="text-align:center; margin-top:20px;">
<!-- Bot√≥n Calculadora -->
<button class="btn-calculadora" onclick="abrirCalculadora()">
  <span class="btn-calculadora__label">CALCULADORA</span>
</button>



</div>


</div>


  <label for="ingreso">Ingresar dinero:</label>
  <input id="ingreso" type="number" placeholder="$0.00">

  <label for="gasto">Descontar dinero:</label>
  <input id="gasto" type="number" placeholder="$0.00">

  <label for="boleta">Subir boleta (opcional):</label>
  <input id="boleta" type="file" accept="image/*">

  <div>
    <button onclick="registrarMovimientoCompleto()">REGISTRAR</button>
    <button onclick="ejecutarResetSaldo()">Resetear saldo √çtem</button>
 <button onclick="window.top.location.href='https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=misboletas'">
  MIS BOLETAS
</button>


  </div>
</div>

<!-- Gesti√≥n √çtems -->
<div class="card">




 <h2>Gesti√≥n de √çtems</h2>
  <label for="nuevoItem">Agregar nuevo √≠tem:</label>
  <input id="nuevoItem" type="text" placeholder="Nombre del √≠tem">
  <button onclick="agregarItem()">Agregar √çtem</button>

  <label for="eliminarItemSelect">Eliminar √≠tem:</label>
  <select id="eliminarItemSelect"></select>
  <button onclick="eliminarItem()" 
        style="margin:20px auto 30px auto; display:block;">
  Eliminar √çtem
</button>



<!-- Bot√≥n WhatsApp debajo de indicadores -->
<div id="whatsapp-btn" onclick="abrirWhatsapp()" 
     style="display:flex; flex-direction:column; align-items:center; justify-content:center; margin:60px auto; cursor:pointer;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"
       style="width:65px; height:65px; filter: drop-shadow(0 0 8px #00ff00);">
  <div class="whatsapp-text" 
       style="text-align:center; font-family:'Orbitron', sans-serif; font-size:40px; font-weight:bold; margin-top:8px; background:linear-gradient(to right,#00f7ff,#8000c8); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
    <span class="arrow" 
          style="display:block; font-size:28px; background:linear-gradient(to right,#00f7ff,#8000c8); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px; animation:bounce 1s infinite;">
      ‚¨Ü
    </span>
    Para ayuda o consultas, <br> ¬°pinche aqu√≠!
  </div>
</div>


<!-- Modal WhatsApp -->
<div id="whatsapp-modal" class="custom-modal"
     onclick="if (event.target === this) cerrarModal('whatsapp-modal')">
  <div class="modal-content">
    <h2>Responderemos a la brevedad</h2>
    
    <!-- ‚úî √öNICO bot√≥n que quieres mantener -->
    <button onclick="enviarMensajeWSP(1)">Necesito ayuda con la aplicaci√≥n</button>

    <span class="close-btn" onclick="cerrarModal('whatsapp-modal')">√ó</span>
  </div>
</div>


</div>



<div id="paginas-modal" class="custom-modal"
     onclick="if (event.target === this) cerrarModal('paginas-modal')">
  <div class="modal-content">
    <span class="close-btn" onclick="cerrarModal('paginas-modal')">√ó</span>

    <h2>Ir a:</h2>

    <!-- ‚úÖ Control Gastos Negocio -->
    <button id="btnControlGastos" style="display:none;"
      onclick="irAPagina(
        'Control Gastos Negocio',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=controlgastosnegocio'
      )">
      Control Gastos Negocio
    </button>

    <!-- ‚úÖ PANEL DE CONTROL -->
    <button id="btnControlPanel" style="display:none;"
      onclick="irAPagina(
        'PANEL DE CONTROL',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=control'
      )">
      PANEL DE CONTROL
    </button>

    <!-- ‚úÖ Tienda -->
    <button id="btnTienda" style="display:none;"
      onclick="irAPagina(
        'Tienda',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=tienda'
      )">
      Tienda
    </button>

    <!-- ‚úÖ Mis Compras -->
    <button id="MisCompras" style="display:none;"
      onclick="irAPagina(
        'Mis Compras',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=miscompras'
      )">
      Mis Compras
    </button>

    <!-- ‚úÖ ¬øC√≥mo van mis finanzas? -->
    <button
      onclick="irAPagina(
        '¬øC√≥mo van mis finanzas?',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=finanzas'
      )">
      ¬øC√≥mo van mis finanzas?
    </button>

    <!-- ‚úÖ Mi Negocio -->
    <button id="btnNegocio" style="display:none;"
      onclick="irAPagina(
        'Mi Negocio',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=negocio'
      )">
      Mi Negocio
    </button>

    <!-- ‚úÖ Cambiar dise√±o p√°ginas -->
    <button
      onclick="irAPagina(
        'Cambiar dise√±o p√°ginas',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=cambiardise√±o'
      )">
      Cambiar dise√±o p√°ginas
    </button>

    <!-- ‚úÖ Visor de Im√°genes IA -->
    <button id="btnVisorImagenes" style="display:none;"
      onclick="irAPagina(
        'Cambiar Estilo de Im√°genes (IA)',
        'https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=visorimagenes'
      )">
      üé® Cambiar Estilo de Im√°genes (IA)
    </button>

    <!-- üî¥ ESTOS NO SE TOCAN (porque no son "ir a p√°gina") -->
    <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    <button onclick="enviarRespaldo()">Respaldar toda mi informaci√≥n</button>
    <button onclick="abrirModalRecordatorio()">üïí Agregar Recordatorio</button>
  </div>
</div>


<!-- üïí Modal para agregar recordatorio avanzado -->
<div id="recordatorio-modal" class="custom-modal"
     onclick="if (event.target === this) cerrarModal('recordatorio-modal')">
  <div class="modal-content">
    <span class="close-btn" onclick="cerrarModal('recordatorio-modal')">√ó</span>
    <h2>Agregar Recordatorio Programado</h2>

    <label for="recordatorioTexto">üìã Escriba su recordatorio:</label>
    <input id="recordatorioTexto" type="text" placeholder="Ej: Pagar luz" 
           style="width:90%; font-size:30px; margin-bottom:15px;">

    <label for="recordatorioFecha">üìÖ Fecha:</label>
    <input id="recordatorioFecha" type="date" 
           style="width:90%; font-size:28px; margin-bottom:15px;">

    <label for="recordatorioHora">üïí Hora:</label>
    <input id="recordatorioHora" type="time" 
           style="width:90%; font-size:28px; margin-bottom:15px;">

    <label for="recordatorioDuracion">‚è±Ô∏è Duraci√≥n visible (minutos):</label>
    <input id="recordatorioDuracion" type="number" placeholder="5" 
           style="width:90%; font-size:28px; margin-bottom:15px;">

    <label for="recordatorioRepetir">üîÅ Repetir:</label>
    <select id="recordatorioRepetir" style="width:90%; font-size:28px; margin-bottom:25px;">
      <option value="ninguno">No repetir</option>
      <option value="diario">Cada d√≠a</option>
      <option value="semanal">Cada semana</option>
    </select>

    <button onclick="guardarRecordatorioProgramado()">üíæ Guardar Recordatorio</button>
  </div>
</div>


<!-- Modal Calculadora -->
<div id="calculadora-modal" class="custom-modal"
     onclick="if (event.target === this) cerrarModal('calculadora-modal')">
  <div class="modal-content" style="max-width:700px; position:relative;">
    <span class="close-btn" onclick="cerrarModal('calculadora-modal')">√ó</span>
    <h2>Calculadora</h2>
    <input type="text" id="calc-display" disabled 
           style="width:95%; font-size:50px; text-align:right; margin-bottom:15px; padding:10px;">

    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:25px;">
      <button onclick="calcInput('7')">7</button>
      <button onclick="calcInput('8')">8</button>
      <button onclick="calcInput('9')">9</button>
      <button onclick="calcInput('/')">√∑</button>

      <button onclick="calcInput('4')">4</button>
      <button onclick="calcInput('5')">5</button>
      <button onclick="calcInput('6')">6</button>
      <button onclick="calcInput('*')">√ó</button>

      <button onclick="calcInput('1')">1</button>
      <button onclick="calcInput('2')">2</button>
      <button onclick="calcInput('3')">3</button>
      <button onclick="calcInput('-')">‚àí</button>

      <button onclick="calcInput('0')">0</button>
      <button onclick="calcInput('.')">.</button>
      <button onclick="calcInput('%')">%</button>
      <button onclick="calcInput('+')">+</button>
   
      <button onclick="calcClear()">AC</button>
               <button onclick="calcSqrt()">‚àö</button>
               <button onclick="calcMS()">MS</button>
      <button onclick="calcMR()">MR</button>
      




      <button onclick="calcBack()" style="grid-column:span 2;">‚å´</button>
      <button onclick="calcCalculate()" style="grid-column:span 2;">=</button>
    </div>
  </div>
</div>



<div id="alertaPersonalizada" style="display: none;"></div>
<script>


  // ‚úÖ Mapa global de overrides de URL
  let mapaPaginas = {};

  // ‚úÖ Cargar el mapa desde Apps Script al iniciar la p√°gina
  function cargarMapaPaginas() {
    google.script.run
      .withSuccessHandler(function(mapa) {
        mapaPaginas = mapa || {};
      })
      .obtenerMapaPaginas();
  }

  // ‚úÖ Funci√≥n √∫nica para ir a una p√°gina
  // nombreBoton = texto que pondr√°s en la columna A de "IR A PAGINA"
  // urlPorDefecto = la URL que hoy ya usas en el onclick
  function irAPagina(nombreBoton, urlPorDefecto) {
    try {
      const clave = (nombreBoton || "").toString().trim().toUpperCase();
      let urlFinal = urlPorDefecto;

      if (mapaPaginas && mapaPaginas[clave]) {
        urlFinal = mapaPaginas[clave];
      }

      if (urlFinal) {
        window.top.location.href = urlFinal;
      } else {
        console.warn("No se encontr√≥ URL para:", nombreBoton);
      }
    } catch (e) {
      console.error("Error en irAPagina:", e);
      // En caso de error, intentamos al menos ir a la URL por defecto
      if (urlPorDefecto) {
        window.top.location.href = urlPorDefecto;
      }
    }
  }

  

// ‚úÖ Obtener URL final de LOGIN (usa hoja IR A PAGINA si existe override)
function obtenerUrlLoginFinal() {
  const urlPorDefecto = "https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=login";

  try {
    // El nombre debe coincidir con la columna A en "IR A PAGINA"
    const clave = "Cerrar Sesi√≥n".toUpperCase(); // "CERRAR SESI√ìN"

    if (mapaPaginas && mapaPaginas[clave]) {
      return mapaPaginas[clave];  // URL nueva desde la hoja
    }
  } catch (e) {
    console.warn("Error obteniendo URL de login desde mapaPaginas:", e);
  }

  // Si no hay override o algo falla ‚Üí usa la URL de siempre
  return urlPorDefecto;
}


// üîπ Logo din√°mico (Index)
function cargarLogo() {
  const usuario = (localStorage.getItem("userName") || "").trim();
  const sheetId = (localStorage.getItem("sheetId") || "").trim();

  google.script.run.withSuccessHandler(respuesta => {
    try {
      const data = (typeof respuesta === "string") ? JSON.parse(respuesta) : respuesta;
      const box = document.getElementById("logoContainer");

      if (data.mostrar && data.url) {
        box.style.display = "flex";
        box.innerHTML = `<img src="${data.url}" alt="Logo"
                          style="width:851px; height:315px; object-fit:contain;">`;
      } else {
        box.style.display = "none";
        box.innerHTML = "";
      }
    } catch(e) {
      console.error("Error cargarLogo:", e);
      const box = document.getElementById("logoContainer");
      box.style.display = "none";
      box.innerHTML = "";
    }
  }).obtenerLogoPaginaUsuario(usuario, "INDEX", sheetId)
;
}



// ... (todo tu JavaScript actual: sesi√≥n, indicadores, movimientos, etc.)

document.addEventListener("DOMContentLoaded", () => {
  verificarSesion();
  cargarLogo();
  cargarFirma();
  cargarMeses();
  cargarItems();
  aplicarVisibilidadPaginas(); 
  cargarPantallaLED();
  cargarMapaPaginas(); 
  restaurarPausaDesdeSheet();

document.getElementById("itemSelect").addEventListener("change", () => {
  const mes = document.getElementById("mesSelect").value;
  const item = (document.getElementById("itemSelect").value || "").trim();
  const pantalla = document.getElementById("contenidoItem");

  // ‚úÖ SIEMPRE LOGO cuando el √≠tem es ITEM
  if (!item || item.toUpperCase() === "ITEM") {
    pantalla.innerHTML = `
      <div style="
        width:100%;
        height:100%;
        display:flex;
        align-items:center;
        justify-content:center;
      ">
        <img src="https://i.imgur.com/tpJr7Xm.png"
              style="
       max-width: 40%;
       max-height: 40%;
       object-fit: contain;
       display: block;
       margin: auto;
       image-rendering: crisp-edges;
       image-rendering: pixelated;
       user-select:none;
     ">
      </div>
    `;
    return; // ‚úÖ BLOQUEAMOS cualquier carga de datos
  }

  // ‚úÖ Si es otro √≠tem ‚Üí mostrar datos normales
  if (mes && item) cargarDetalleItem(mes, item);
});




  // ‚úÖ Diferenciar roles (admin vs usuario)
const isAdmin = localStorage.getItem("isAdmin") === "true";

const btnNegocio        = document.getElementById("btnNegocio");
const btnControlGastos  = document.getElementById("btnControlGastos");
const btnVisorImagenes  = document.getElementById("btnVisorImagenes");
const btnControlPanel   = document.getElementById("btnControlPanel"); // üëà NUEVO

if (!isAdmin) {
  // Usuarios normales ‚Üí NO ven estos botones
  if (btnNegocio)       btnNegocio.style.display       = "none";
  if (btnControlGastos) btnControlGastos.style.display = "none";
  if (btnVisorImagenes) btnVisorImagenes.style.display = "none";
  if (btnControlPanel)  btnControlPanel.style.display  = "none"; // üëà SE OCULTA
}
// Si isAdmin === true, NO tocamos nada ‚Üí t√∫ ves el bot√≥n normalmente

});

// ‚úÖ Sesi√≥n
function verificarSesion() {
  if (localStorage.getItem("usuarioLogueado") !== "true") {
    window.top.location.replace(
      "https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=login"
    );
  }
}

function cerrarSesion() {
  try {
    const usuarioActual =
      localStorage.getItem("usuarioActivo") ||
      localStorage.getItem("userName");

    // ====================================================
    // ‚úÖ NUEVO: guardar pausa del video ANTES de cerrar sesi√≥n
    // (NO altera ninguna l√≥gica existente)
    // ====================================================
    try {
      if (typeof guardarPausaEnSheet === "function") {
        guardarPausaEnSheet();
      }
    } catch (e) {
      console.warn("No se pudo guardar la pausa al cerrar sesi√≥n:", e);
    }

    // üîπ Registrar al usuario como OFFLINE antes de eliminar sus datos
    if (usuarioActual) {
      google.script.run.registrarOffline(usuarioActual);
    }

    // üîπ Guardar estilos personales antes de limpiar la sesi√≥n
    const estilosUsuario = {};
    if (usuarioActual) {
      for (const clave of Object.keys(localStorage)) {
        if (
          clave.startsWith(`theme_${usuarioActual}`) ||
          clave.startsWith(`tipografia_${usuarioActual}`)
        ) {
          estilosUsuario[clave] = localStorage.getItem(clave);
        }
      }
    }

    // üîπ Eliminar solo los datos de sesi√≥n
    const clavesSesion = [
      "usuarioActivo",
      "usuarioLogueado",
      "correoActivo",
      "sheetId",
      "carpetaId",
      "isAdmin",
      "userName"
    ];
    clavesSesion.forEach(k => localStorage.removeItem(k));

    // üîπ Restaurar estilos del usuario
    for (const clave in estilosUsuario) {
      localStorage.setItem(clave, estilosUsuario[clave]);
    }

    // üîπ Asegurar que quede marcada la sesi√≥n como cerrada
    localStorage.setItem("usuarioLogueado", "false");

    // üîπ Intentar mostrar alerta, si existe
    try {
      if (typeof mostrarAlerta === "function") {
        mostrarAlerta("üëã Has cerrado sesi√≥n correctamente.");
      }
    } catch (e) {
      console.warn("mostrarAlerta fall√≥:", e);
    }

    // üîπ Usar la URL final (override o por defecto)
    const urlLogin = obtenerUrlLoginFinal();

    // üîπ Esperar un instante para que se vea la alerta
    setTimeout(() => {
      google.script.run
        .withSuccessHandler(() => {
          window.location.href = urlLogin;
        })
        .dummy(); // funci√≥n vac√≠a del servidor
    }, 300);

  } catch (error) {
    console.error("Error en cerrarSesion:", error);

    // üîπ Mantener la l√≥gica de IR A PAGINA (fallback)
    irAPagina(
      "Cerrar Sesi√≥n",
      "https://script.google.com/macros/s/AKfycbxeUZqjh8r6Ca5Vrq7jWaszNCVOVymY1W9ozgqoD025-jo2Tz8-snK2k84WhC0GpdRs6A/exec?page=login"
    );
  }
}


// ============================================================
// üîπ PANTALLA LED ‚Äî versi√≥n mejorada y adaptada a ControlGastoNegocio
// ============================================================

let textoLED = "";
let firmaHTML = "";

// ‚úÖ Cargar la firma (usa mismo backend que index)
function cargarFirma() {
  const usuario = (localStorage.getItem("userName") || "").trim();
  google.script.run.withSuccessHandler(respuesta => {
    try {
      const data = (typeof respuesta === "string") ? JSON.parse(respuesta) : respuesta;
      if (data.mostrar && data.url) {
        firmaHTML = `<img src="${data.url}" alt="Firma" style="width:180px; height:auto; margin-right:15px; vertical-align:middle; filter:drop-shadow(0 0 6px #fff);">`;
      } else firmaHTML = "";
    } catch {
      firmaHTML = "";
    }
  }).obtenerLogo("FIRMA", usuario);
}

// ============================================================
// üîπ CARGA PRINCIPAL
// ============================================================

// üîπ Cargar texto din√°mico en la pantalla LED (respeta reglas + firma + usuario)
function cargarPantallaLED() {
  const page = document.body.getAttribute("data-page") || "index";
  const usuario = (localStorage.getItem("userName") || "").trim();

  google.script.run.withSuccessHandler(function(texto) {
    const contenedor = document.getElementById("indicadores");
    textoLED = texto; // ‚Üê mantiene tal cual lo que devuelve Code.gs (incluye "INDICADORES" cuando corresponde)

    // Asegura existencia del span destino
    if (!document.getElementById("ledContent")) {
      contenedor.innerHTML = '<span id="ledContent"></span>';
    }
    const led = document.getElementById("ledContent");

 if ((texto || "").toUpperCase().startsWith("INDICADORES")) {
  // 0) Captura "extra" tras la palabra INDICADORES (p.ej. un GIF que pusiste al lado)
  const extra = texto.slice("INDICADORES".length).trim();

  // Helper para extraer URLs de imagen desde un HTML generado (<img src="...">)
  function collectImgSrc(html) {
    const out = [];
    if (!html) return out;
    const re = /<img[^>]+src="([^"]+)"/gi;
    let m;
    while ((m = re.exec(html)) !== null) out.push(m[1]);
    return out;
  }

  // 1) Pide valores de indicadores
  google.script.run.withSuccessHandler(data => {
    if (!document.getElementById("ledContent")) {
      contenedor.innerHTML = '<span id="ledContent"></span>';
    }
    const led = document.getElementById("ledContent");

    const dolar = (data && data.dolar != null) ? Number(data.dolar).toLocaleString("es-CL") : "-";
    const uf    = (data && data.uf    != null) ? Number(data.uf   ).toLocaleString("es-CL") : "-";
    const utm   = (data && data.utm   != null) ? Number(data.utm  ).toLocaleString("es-CL") : "-";

    // 2) Base: firma + indicadores + , usuario
    let baseHTML = `
      ${firmaHTML ? (firmaHTML + ' ') : ''} 
      üí≤ D√≥lar: $${dolar} |
      üßæ UF: $${uf} |
      üìä UTM: $${utm}
      ${usuario ? `, ${usuario}` : ""}
    `.trim();

    // 3) Pide adjuntos (Fila 2/3) y construye im√°genes √öNICAS combinando extra+adjuntos
    google.script.run.withSuccessHandler(adjuntosStr => {
      const set = new Set();

      // a) Im√°genes del "extra" al lado de INDICADORES
      if (extra) {
        const { imagesHTML: imgExtra } = splitTextAndImageUrls(extra);
        collectImgSrc(imgExtra).forEach(u => set.add(u));
      }

      // b) Im√°genes desde Fila 2/3 (funci√≥n auxiliar del backend)
      const adj = (adjuntosStr || "").trim();
      if (adj) {
        const { imagesHTML: imgAdj } = splitTextAndImageUrls(adj);
        collectImgSrc(imgAdj).forEach(u => set.add(u));
      }

      // c) Renderizar solo una vez cada imagen (sin duplicados)
      if (set.size > 0) {
        const uniqueImagesHTML = " " + Array.from(set).map(u => `<img src="${u}" alt="imagen">`).join(" ");
        baseHTML = baseHTML.replace(
          `${usuario ? `, ${usuario}` : ""}`,
          `${uniqueImagesHTML} ${usuario ? `, ${usuario}` : ""}`
        ).trim();
      }

      led.innerHTML = baseHTML;
    }).obtenerAdjuntosPantalla(page, usuario);


  }).getIndicadores();
} else {
  // Mensajes normales ‚Üí firma + mensaje + im√°genes (si hay) + ", Usuario"
  if (!document.getElementById("ledContent")) {
    contenedor.innerHTML = '<span id="ledContent"></span>';
  }
  actualizarPantallaLED(usuario);
}



  }).obtenerTextoPantalla(page, usuario);
}

// ‚úÖ Render final de la pantalla LED
function actualizarPantallaLED(usuario = "") {
  const u = (usuario || localStorage.getItem("userName") || "").trim();
  const contenedorLED = document.getElementById("indicadores");
  if (!document.getElementById("ledContent")) {
    contenedorLED.innerHTML = '<span id="ledContent"></span>';
  }
  const led = document.getElementById("ledContent");
  const mensaje = textoLED || "";

  // Detectar si hay videos
  const videoLinks = (mensaje || "")
    .split(/[\n,]+/)
    .map(l => l.trim())
    .filter(l => l && (l.includes(".mp4") || l.includes(".webm") || l.includes(".mov") || l.includes("youtube") || l.includes("youtu.be")));

  // ‚≠ê 1) DETECTAR VIDEOS (tu l√≥gica original)
const esVideo = videoLinks.length > 0;

// ‚≠ê 2) DETECTAR IM√ÅGENES EN BUCLE
const imagenLinks = (mensaje || "")
  .split(/[,]+/)
  .map(x => x.trim())
  .filter(x =>
    /\.(jpg|jpeg|png|gif|webp)$/i.test(
      x.split("(")[0].trim()
    )
  );
const esImagen = imagenLinks.length > 0;


/* ======================================================
   üé¨ SI ES VIDEO ‚Üí SE MANTIENE EXACTAMENTE TU MODO VIDEO
   ====================================================== */
if (esVideo) {
  contenedorLED.classList.add("modo-video");
  contenedorLED.style.padding = "0px";
  contenedorLED.style.overflow = "hidden";

  reproducirVideosEnBucle(videoLinks);
  return;
}


/* ============================================================
   üñºÔ∏è SI ES IMAGEN ‚Üí NUEVO MODO IMAGEN FULL SCREEN EN BUCLE
   (id√©ntico comportamiento que los videos + texto desplazado)
   ============================================================ */
if (esImagen) {
  contenedorLED.classList.add("modo-video");  // LED grande igual que video
  contenedorLED.style.padding = "0px";
  contenedorLED.style.overflow = "hidden";

  reproducirImagenesEnBucle(imagenLinks);
  return;
}


// ‚úÖ SI NO ES VIDEO ‚Üí VOLVER A TEXTO NORMAL
contenedorLED.classList.remove("modo-video");
contenedorLED.style.padding = "30px";
  contenedorLED.style.overflow = "hidden";

  const { textHTML, imagesHTML } = splitTextAndImageUrls(mensaje);

  led.innerHTML = `
    ${firmaHTML ? firmaHTML + ' ' : ''}
    ${textHTML}
    ${imagesHTML}
    ${u ? `, ${u}` : ''}
  `.trim();

  led.style.animation = "scroll 16s linear infinite";
}

// ‚úÖ FUNCI√ìN FINAL ‚Äì enlace solo en video o texto + mute funcional
function reproducirVideosEnBucle(videoLinks) {
  const contenedorLED = document.getElementById("indicadores");
  let index = 0;

  function reproducir() {
    let link = videoLinks[index];
    let videoURL = link;
    let linkDestino = null;

    if (link.includes("(") && link.includes(")")) {
      const partes = link.split("(");
      videoURL = partes[0].trim();
      linkDestino = partes[1].replace(")", "").trim();
    }
    if (linkDestino && !/^https?:\/\//i.test(linkDestino)) {
      linkDestino = "https://" + linkDestino;
    }

    contenedorLED.innerHTML = `
      <div id="videoLED-container" style="
  width:100%; 
  height:350px;
  display:flex; 
  justify-content:center; 
  align-items:center;
  overflow:hidden; 
  border-radius:18px;
  background: repeating-linear-gradient(
    to right,
    rgba(0,0,0,0.95) 0px,
    rgba(0,0,0,0.95) 2px,
    rgba(40,40,40,0.95) 2px,
    rgba(40,40,40,0.95) 4px
  );
  position:relative;
">
        <video id="videoLED" autoplay muted playsinline style="
    width:auto;
    height:350px;
    max-width:100%;
    object-fit:contain;
    border:none;
    cursor:pointer;
  ">
          <source src="${videoURL}">
  </video>

</div>


        ${linkDestino ? `
          <div id="textoClickVideo" style="
            position:absolute;
            bottom:15px;
            overflow:hidden;
            white-space:nowrap;
            pointer-events:auto;
            cursor:pointer;
          ">
            <span id="scrollTextVideo" style="
              display:inline-block;
              color:inherit;
              font-family:'Orbitron',sans-serif;
              font-size:22px;
              font-weight:bold;
              animation:scrollVideoText 25s linear infinite;
              will-change:transform;
              user-select:none;
            ">
              Pincha aqu√≠ para m√°s informaci√≥n
            </span>
          </div>
        ` : ""}
      </div>
    `;

    const video = document.getElementById("videoLED");
    const textoClick = document.getElementById("textoClickVideo");
    const muteButton = document.getElementById("muteButton");
    const icono = document.getElementById("iconoMute");

    // ‚úÖ Asegura que el texto se alinee correctamente
    video.addEventListener("loadedmetadata", () => {
      if (textoClick && video.clientWidth > 0) {
        textoClick.style.width = video.clientWidth + "px";
        textoClick.style.left = "50%";
        textoClick.style.transform = "translateX(-50%)";
      }
    });

    // ‚úÖ Click solo en video o texto abre enlace
    function abrirDestino() {
      if (linkDestino) window.open(linkDestino, "_blank", "noopener,noreferrer");
    }
    if (textoClick && linkDestino)
      textoClick.addEventListener("click", e => { e.stopPropagation(); abrirDestino(); });
    if (video && linkDestino)
      video.addEventListener("click", e => { e.stopPropagation(); abrirDestino(); });

   
    // ‚úÖ Impide pausas
    video.addEventListener("pause", () => video.play().catch(()=>{}));

    // ‚úÖ Bucle entre m√∫ltiples videos
    video.onended = () => {
      index = (index + 1) % videoLinks.length;
      reproducir();
    };
  }

  reproducir();
}// üéûÔ∏è Animaci√≥n continua del texto dentro del video
const styleScroll = document.createElement("style");
styleScroll.textContent = `
@keyframes scrollVideoText {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}
`;
document.head.appendChild(styleScroll);

// ‚úÖ MUTE del LED solo si hay video
function activarMuteLED() {
  const video = document.getElementById("videoLED");
  const muteBtn = document.getElementById("muteButton");
  const icono = document.getElementById("iconoMute");

  if (!video || !muteBtn) return;

  video.muted = true;
  icono.textContent = "üîá";

  forzarAutoplay(video);

  // Tocando la pantalla LED se activa el sonido
  video.addEventListener("click", () => {
    video.muted = false;
    icono.textContent = "üîä";
    video.play().catch(()=>{});
  });

  // Bot√≥n mute manual
  muteBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    video.muted = !video.muted;
    icono.textContent = video.muted ? "üîá" : "üîä";
    if (!video.muted) video.play().catch(()=>{});
  });
}

// Se activa cuando aparece un nuevo video LED
setTimeout(() => activarMuteLED(), 500);

// ‚úÖ Ejecutar cada vez que se renderiza un video en el LED
document.addEventListener("DOMNodeInserted", () => {
  if (document.getElementById("videoLED")) {
    activarMuteLED();
  }
});




// üîí Escapar HTML
function escapeHTML(str) {
  return String(str).replace(/[&<>"']/g, m => (
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]
  ));
}

// üñºÔ∏è ¬øEs URL de imagen?
function isImageUrl(url) {
  return /\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(url);
}

// ‚úÇÔ∏è Separa en "texto con links no-imagen" + "im√°genes al final"
function splitTextAndImageUrls(textoPlano) {
  if (!textoPlano) return { textHTML: "", imagesHTML: "" };

  const safe = escapeHTML(textoPlano);
  const urlRegex = /(https?:\/\/[^\s<>"']+)/gi;
  const imageTags = [];

  let textWithLinks = safe.replace(urlRegex, (match) => {
    const url = match.trim();
    if (isImageUrl(url)) {
      imageTags.push(`<img src="${url}" alt="imagen" />`);
      return ""; // sacamos del texto para ponerla al final como imagen
    }
    // URL que no es imagen => queda como <a>
    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
  });

  const imagesHTML = imageTags.length ? " " + imageTags.join(" ") : "";
  return { textHTML: textWithLinks.trim(), imagesHTML };
}


// ‚≠ê NUEVO ‚≠ê
// üìå Reproducir im√°genes en bucle, igual que los videos LED
function reproducirImagenesEnBucle(imagenLinks) {
  const contenedorLED = document.getElementById("indicadores");

  // --- CREAR SOLO UNA VEZ EL CONTENEDOR ---
  contenedorLED.innerHTML = `
    <div id="imgContainerLED" style="
      width:100%; height:100%; 
      display:flex; justify-content:center; align-items:center;
      position:absolute; top:0; left:0;
      overflow:hidden; cursor:pointer;">
      <img id="imgLED" src="" style="
        width:100%; height:100%; object-fit:cover; border:none;">
    </div>

    <div id="textoClickImagen" style="
      position:absolute; bottom:10px; left:0; width:100%;
      overflow:hidden; white-space:nowrap; pointer-events:auto;">
      <span id="scrollTextImagen" style="
        display:inline-block; padding-left:100%;
        font-family:'Orbitron',sans-serif; font-size:26px;
        font-weight:bold; animation:scrollTextImagen 18s linear infinite;">
        Pincha aqu√≠ para m√°s informaci√≥n
      </span>
    </div>
  `;

  const img = document.getElementById("imgLED");
  const textoClick = document.getElementById("textoClickImagen");
  const imgContainer = document.getElementById("imgContainerLED"); // üëà nuevo

  let index = 0;
  let linkDestino = null;

  function mostrarImagen() {
    let item = imagenLinks[index];
    linkDestino = null;

    // formato:  imagen(URL.jpg)(https://destino.cl)
    if (item.includes("(") && item.includes(")")) {
      let partes = item.split("(");
      item = partes[0].trim();
      linkDestino = partes[1].replace(")","").trim();
      if (!linkDestino.startsWith("http")) linkDestino = "https://" + linkDestino;
    }

    img.src = item;

    // --- CLICK SI LA IMAGEN TIENE LINK ---
    if (linkDestino) {
      textoClick.style.display = "block";

      // texto clickeable
      textoClick.onclick = () => window.open(linkDestino, "_blank");

      // üî• NUEVO: la imagen completa es clickeable
      imgContainer.onclick = () => window.open(linkDestino, "_blank");
      img.onclick = () => window.open(linkDestino, "_blank");

    } else {
      textoClick.style.display = "none";

      // desactivar clics
      textoClick.onclick = null;
      imgContainer.onclick = null;
      img.onclick = null;
    }

    index = (index + 1) % imagenLinks.length;
    setTimeout(mostrarImagen, 4000); // 4 segundos por imagen
  }

  mostrarImagen();
}





// Meses e √çtems
const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
document.addEventListener("DOMContentLoaded", () => {
  cargarMeses();
  cargarItems();

  // ‚úÖ Forzar actualizaci√≥n inicial para que se muestre tu logo al inicio
  setTimeout(() => {
    document.getElementById("itemSelect").dispatchEvent(new Event("change"));
  }, 400);
});


function cargarMeses() {
  const select = document.getElementById("mesSelect");
  select.innerHTML = "";
  meses.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.text = m;
    select.appendChild(opt);
  });
}
function cargarItems() {
  const mes = document.getElementById("mesSelect").value;
  const sheetId = localStorage.getItem("sheetId") || null;

  if (!mes) {
    mostrarAlertaFuturista("Seleccione un mes antes de cargar √≠tems");
    return;
  }

  // Guardar selecci√≥n actual para intentar restaurarla despu√©s
  const itemSelect = document.getElementById("itemSelect");
  const eliminarSelect = document.getElementById("eliminarItemSelect");
  const itemActual = itemSelect ? itemSelect.value : "";

  google.script.run
    .withSuccessHandler(items => {
      // Vaciar selects
      itemSelect.innerHTML = "";
      if (eliminarSelect) eliminarSelect.innerHTML = "";

      if (items && items.length > 0) {
        // Poblar selects con las opciones recuperadas
        items.forEach(item => {
          itemSelect.appendChild(new Option(item, item));
          if (eliminarSelect) eliminarSelect.appendChild(new Option(item, item));
        });

        // Si el √≠tem que el usuario ten√≠a antes existe en la nueva lista, restaurarlo
if (itemActual && items.includes(itemActual)) {
  itemSelect.value = itemActual;

  // ‚úÖ Si el √≠tem seleccionado es ITEM ‚Üí mostrar logo y NO cargar datos
  if (itemActual.toUpperCase() === "ITEM") {
    document.getElementById("itemSelect").dispatchEvent(new Event("change"));
  } else {
    cargarDetalleItem(mes, itemActual);
  }

} else {
  // Si no existe, seleccionar la primera opci√≥n v√°lida y actualizar
  itemSelect.selectedIndex = 0;
  const primerItem = itemSelect.value;

  // ‚úÖ Tambi√©n evitar carga si ese primer √≠tem es ITEM
  if (primerItem && primerItem.toUpperCase() !== "ITEM") {
    cargarDetalleItem(mes, primerItem);
  } else {
    document.getElementById("itemSelect").dispatchEvent(new Event("change"));
  }
}
} else {
  // No hay √≠tems
  itemSelect.appendChild(new Option("No hay √≠tems", ""));
  if (eliminarSelect) eliminarSelect.appendChild(new Option("No hay √≠tems", ""));
  
  // ‚úÖ Si no hay datos ‚Üí tambi√©n mostrar logo, nunca texto feo
  document.getElementById("contenidoItem").innerHTML = `
    <div style="
      width:40%;
      height:40%;
      display:flex;
      align-items:center;
      justify-content:center;
    ">
      <img src="https://i.imgur.com/tpJr7Xm.png"
           style="
             width:40%;
             height:40%;
             object-fit:contain;
             user-select:none;
           ">
    </div>
  `;
}
})
.withFailureHandler(err => {
  mostrarAlerta("Error al cargar √≠tems: " + (err.message || err));
})
.obtenerItems(mes, sheetId);
}



// Registrar Movimiento
function registrarMovimientoCompleto() {
  const mes = document.getElementById("mesSelect").value;
  const item = document.getElementById("itemSelect").value;
  const ingreso = parseFloat(document.getElementById("ingreso").value) || 0;
  const gasto = parseFloat(document.getElementById("gasto").value) || 0;
  const fileInput = document.getElementById("boleta");

  if (!mes || !item) {
    mostrarAlertaFuturista("‚ö†Ô∏è Selecciona mes e √≠tem.");
    return;
  }

  // Convertir boleta a base64 si existe
  if (fileInput.files.length > 0) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64 = e.target.result.split(",")[1];
      google.script.run.withSuccessHandler(msg => {
        mostrarAlertaFuturista(msg);

        // üîπ Refrescar datos del √≠tem en la pantalla Game Boy
        cargarDetalleItem(mes, item);

        // limpiar inputs
        document.getElementById("ingreso").value = "";
        document.getElementById("gasto").value = "";
        fileInput.value = "";
      }).registrarMovimientoConBoleta(mes, item, ingreso, gasto, base64,
        localStorage.getItem("sheetId"), localStorage.getItem("carpetaId"));
    };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    google.script.run.withSuccessHandler(msg => {
      mostrarAlertaFuturista(msg);

      // üîπ Refrescar datos del √≠tem en la pantalla Game Boy
      cargarDetalleItem(mes, item);

      // limpiar inputs
      document.getElementById("ingreso").value = "";
      document.getElementById("gasto").value = "";
    }).registrarMovimientoConBoleta(mes, item, ingreso, gasto, null,
      localStorage.getItem("sheetId"), localStorage.getItem("carpetaId"));
  }
}

function limpiarCampos() {
  document.getElementById("ingreso").value = "";
  document.getElementById("gasto").value = "";
  document.getElementById("boleta").value = "";
}
function agregarItem() {
  const nuevoItem = document.getElementById("nuevoItem").value.trim();
  const mes = document.getElementById("mesSelect").value;

  // ‚ö°Ô∏è IDs din√°micos
  const sheetId = localStorage.getItem("sheetId") || null;

  if (nuevoItem) {
    google.script.run
      .withSuccessHandler(() => {
        mostrarAlertaFuturista("√çtem agregado");
        cargarItems();
        document.getElementById("nuevoItem").value = "";
      })
      .withFailureHandler((err) => {
        mostrarAlerta("Error al agregar √≠tem: " + err.message);
      })
      // üëá se mantienen los par√°metros originales (nuevoItem, mes),
      // y se pasa sheetId de forma adicional
      .agregarItem(nuevoItem, mes, sheetId);
  }
}

function eliminarItem() {
  const item = document.getElementById("eliminarItemSelect").value;
  const mes = document.getElementById("mesSelect").value;

  // ‚ö°Ô∏è IDs din√°micos
  const sheetId = localStorage.getItem("sheetId") || null;

  if (item && mes) {
    google.script.run
      .withSuccessHandler(() => {
        mostrarAlertaFuturista("√çtem eliminado");
        cargarItems();
      })
      .withFailureHandler((err) => {
        mostrarAlerta("Error al eliminar √≠tem: " + err.message);
      })
      // üëá par√°metros originales (item, mes) + sheetId din√°mico
      .eliminarItem(item, mes, sheetId);
  }
}

function enviarRespaldo() {
  google.script.run.withSuccessHandler(function(respuesta) {
    if (respuesta === "OK") {
      mostrarAlertaFuturista("üì¶ Respaldo enviado exitosamente a su correo");
    } else {
      mostrarAlertaFuturista("‚ùå " + respuesta);
    }
  }).respaldarInformacionCompleta();
}

function aplicarVisibilidadPaginas() {
  google.script.run.withSuccessHandler(paginas => {
    // Control Gastos Negocio
    if (paginas["CONTROL GASTOS NEGOCIO"] === false) {
      document.getElementById("btnControlGastos").style.display = "none";
    } else {
      document.getElementById("btnControlGastos").style.display = "inline-block";
    }

    // Mi Negocio
    if (paginas["NEGOCIO"] === false) {
      document.getElementById("btnNegocio").style.display = "none";
    } else {
      document.getElementById("btnNegocio").style.display = "inline-block";
    }

    // üé® Visor de Im√°genes IA
    if (paginas["VISOR IMAGENES"] === false) {
      document.getElementById("btnVisorImagenes").style.display = "none";
    } else {
      document.getElementById("btnVisorImagenes").style.display = "inline-block";
    }
  }).obtenerPaginasVisibles();
}



let numeroWhatsapp = "";
google.script.run.withSuccessHandler(function(num){
  if (typeof num === "string") numeroWhatsapp = num.replace(/\D/g, "");
}).obtenerWhatsapp();


function abrirWhatsapp() {
  document.getElementById('whatsapp-modal').style.display = 'flex';
}

function enviarMensajeWSP(opcion) {
  let mensaje = "";
  if (opcion === 1) mensaje = "Hola, necesito ayuda con la aplicaci√≥n.";
  if (opcion === 2) mensaje = "Hola, quisiera comprar banners de animaci√≥n.";
  const url = "https://wa.me/" + numeroWhatsapp + "?text=" + encodeURIComponent(mensaje);
  cerrarModal();
  window.open(url, "_blank");
}

// --- Manejo unificado: actualizar pantalla GameBoy cuando cambie mes o √≠tem ---
function actualizarPantallaGameBoy() {
  const mes = document.getElementById("mesSelect").value;
  const item = document.getElementById("itemSelect").value;
  if (mes && item) {
    // Usa la funci√≥n existente que ya maneja la l√≥gica de carga
    cargarDetalleItem(mes, item);
  }
}


// mesSelect: cuando cambie el mes, recargamos la lista de items para ese mes
// y luego, si el √≠tem anterior existe en el nuevo mes, lo restauramos y actualizamos la pantalla.
document.getElementById("mesSelect").addEventListener("change", function () {
  const prevItem = document.getElementById("itemSelect").value || "";
  const mes = document.getElementById("mesSelect").value;

  // 1) recarga items para el mes seleccionado (funci√≥n ya existente)
  cargarItems();

  // 2) tras una peque√±a espera para que cargarItems haya poblado el select,
  // intentamos restaurar el item previo y actualizar la pantalla.
  // Si prefieres un enfoque m√°s robusto, podemos convertir cargarItems en una versi√≥n que acepte callback.
  setTimeout(() => {
    const itemSelect = document.getElementById("itemSelect");
    if (!itemSelect) return;

    // Si el item previo existe en la nueva lista, mantenlo seleccionado
    if (prevItem && Array.from(itemSelect.options).some(o => o.value === prevItem)) {
      itemSelect.value = prevItem;
    }
    // Finalmente, actualizar la pantalla si ambos valores existen
    const item = itemSelect.value;
    if (mes && item) cargarDetalleItem(mes, item);
  }, 350); // 350 ms suele ser suficiente; si tu conexi√≥n es lenta puedes subirlo a 600
});


function mostrarAlertaFuturista(mensaje) {
  const alerta = document.createElement("div");
  alerta.className = "alerta-futurista";
  alerta.innerText = mensaje;
  document.body.appendChild(alerta);
  setTimeout(() => alerta.remove(), 4500);
}function mostrarTablaGameboy(filas) {
  const pantalla = document.getElementById('contenidoItem');
  if (!filas || filas.length === 0) {
    pantalla.innerHTML = "<span style='color:black'>NO SE ENCONTRARON DATOS</span>";
    return;
  }

  let html = "<table class='table-gameboy'>";
  filas.forEach((fila, index) => {
    html += `<tr style="animation-delay:${index * 0.2}s;">`;
    fila.forEach(celda => {
      html += `<td>${celda}</td>`;
    });
    html += `</tr>`;
  });
  html += "</table>";

  pantalla.innerHTML = html;
}



// Abrir modal WhatsApp
function abrirWhatsapp() {
  document.getElementById('whatsapp-modal').style.display = 'flex';
}

// Abrir modal P√°ginas
function abrirPaginas() {
  document.getElementById('paginas-modal').style.display = 'flex';
}

function cerrarModal(id) {
  if (id) {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
    return;
  }
  ['whatsapp-modal', 'paginas-modal', 'calculadora-modal', 'recordatorio-modal'].forEach(mid => {
  const el = document.getElementById(mid);
  if (el && el.style.display !== 'none') el.style.display = 'none';
});

}


// Cerrar con tecla ESC
document.addEventListener('keydown', function (e) {
  if (e.key === 'Escape') {
    cerrarModal(); // sin id => cierra cualquiera que est√© abierto
  }
});

// ‚úÖ Abrir calculadora (no borra; restaura el √∫ltimo valor)
function abrirCalculadora() {
  document.getElementById("calculadora-modal").style.display = "flex";
  const last = localStorage.getItem("calcDisplayValue") || "";
  document.getElementById("calc-display").value = last;
}

// ‚úÖ Guardar el valor actual del display
function saveCalc() {
  const display = document.getElementById("calc-display");
  if (display) localStorage.setItem("calcDisplayValue", display.value || "");
}


// ‚úÖ Entrada por botones
function calcInput(val) {
  const display = document.getElementById("calc-display");
  display.value += val;
  saveCalc();
}

// ‚úÖ Borrar todo (AC)
function calcClear() {
  const display = document.getElementById("calc-display");
  display.value = "";
  saveCalc();
}

// ‚úÖ Borrar √∫ltimo d√≠gito
function calcBack() {
  const display = document.getElementById("calc-display");
  display.value = display.value.slice(0, -1);
  saveCalc();
}

// ‚úÖ Calcular
function calcCalculate() {
  const display = document.getElementById("calc-display");
  try {
    let expr = display.value;

    // üîπ Detectar expresiones como "5000 - 20%" o "5000 + 20%"
    expr = expr.replace(/(\d+)\s*([\+\-])\s*(\d+)%/g, (match, num, op, percent) => {
      const base = parseFloat(num);
      const p = parseFloat(percent) / 100;
      return op === "+" ? base + (base * p) : base - (base * p);
    });

    // üîπ Convertir otros usos de % en "/100"
    expr = expr.replace(/(\d+)%/g, (match, num) => parseFloat(num) / 100);

    // ‚úÖ Evaluar
    display.value = Function('"use strict";return (' + expr + ")")();
  } catch {
    display.value = "Error";
  }
  saveCalc();
}

// ‚úÖ Calcular ra√≠z cuadrada del valor actual
function calcSqrt() {
  const display = document.getElementById("calc-display");
  try {
    display.value = Math.sqrt(parseFloat(display.value)) || "";
  } catch {
    display.value = "Error";
  }
  saveCalc();
}

// ‚úÖ Guardar en memoria (MS)
function calcMS() {
  const display = document.getElementById("calc-display");
  window.memoryStore = parseFloat(display.value) || 0;
  mostrarAlertaFuturista("üíæ Guardado en memoria: " + window.memoryStore);
  saveCalc();
}

// ‚úÖ Promedio
function avg(...nums) {
  const arr = nums.map(Number);
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}

// ‚úÖ Compatibilidad con teclado f√≠sico (sin exigir foco en el display)
document.addEventListener("keydown", function (e) {
  const modal = document.getElementById("calculadora-modal");
  const display = document.getElementById("calc-display");
  if (!modal || modal.style.display !== "flex" || !display) return;

  // N√∫meros y operadores
  if ((e.key >= "0" && e.key <= "9") || ["+", "-", "*", "/", "."].includes(e.key)) {
    display.value += e.key;
    saveCalc();
    e.preventDefault();
    return;
  }

  // Enter = calcular
  if (e.key === "Enter") {
    calcCalculate();
    e.preventDefault();
    return;
  }

  // Backspace = borrar √∫ltimo
  if (e.key === "Backspace") {
    calcBack();
    e.preventDefault();
    return;
  }

  // C = clear, S = sqrt, M = MS (memoria)
  const k = e.key.toLowerCase();
  if (k === "c") { calcClear(); e.preventDefault(); return; }
  if (k === "s") { calcSqrt();  e.preventDefault(); return; }
  if (k === "m") { calcMS();    e.preventDefault(); return; }

  // Escape = cerrar modal
  if (e.key === "Escape") {
    cerrarModal("calculadora-modal");
    e.preventDefault();
    return;
  }
});

function cargarDetalleItem(mes, item, reset = false) {
  const sheetId = localStorage.getItem("sheetId") || "";

  if (reset) {
    // Primero resetea el saldo en la hoja
    google.script.run.withSuccessHandler(msg => {
      mostrarAlertaFuturista(msg);

      // Luego vuelve a leer el detalle SOLO de ese √≠tem
      google.script.run.withSuccessHandler(detalle => {
        renderizarPantallaItem(mes, item, detalle);
      }).obtenerDetalleItem(mes, item, sheetId);

    }).resetearSaldoItem(mes, item, sheetId);

  } else {
    // Caso normal: solo leer el detalle de ese √≠tem
    google.script.run.withSuccessHandler(detalle => {
      renderizarPantallaItem(mes, item, detalle);
    }).obtenerDetalleItem(mes, item, sheetId);
  }
}



// ‚úÖ Ahora recibe el "detalle" de un solo √≠tem (obtenerDetalleItem),
// pero mantiene el mismo dise√±o y efecto de siempre.
function renderizarPantallaItem(mes, item, detalle) {
  const cont = document.getElementById("contenidoItem");

  // ‚úÖ Si el √≠tem seleccionado es "√çtem" mostrar solo el logo centrado
  if (item === "√çtem") {
    cont.classList.remove("animarEntrada");
    cont.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:center; width:40%; height:40%;">
        <img src="https://i.imgur.com/tpJr7Xm.png" style="max-width:40%; height:auto;" />
      </div>
    `;
    return;
  }

  // Si no lleg√≥ nada desde el backend
  if (!detalle) {
    cont.classList.remove("animarEntrada");
    cont.innerHTML = "‚ùå Sin datos para este √≠tem";
    return;
  }

  // Nombre bonito para mostrar
  const nombreMostrar = (detalle.nombre || item || "").toString();
  const mesUpper = mes.toUpperCase();
  const itemFormat = nombreMostrar.charAt(0).toUpperCase() + nombreMostrar.slice(1).toLowerCase();

  let ingresos = 0;
  let gastos   = 0;
  let saldo    = 0;

  if (detalle.rangoEspecial) {
    // ‚ÑπÔ∏è Casos especiales (A22:A33, como SALDO A FAVOR / DINEROS)
    ingresos = detalle.saldo || 0; // mostramos todo como "Ingresos"
    gastos   = 0;
    saldo    = detalle.saldo || 0;
  } else {
    // Caso normal
    ingresos = detalle.destinado || 0;
    gastos   = detalle.gastado   || 0;
    saldo    = (detalle.saldo !== undefined ? detalle.saldo : (ingresos - gastos)) || 0;
  }

  cont.classList.remove("animarEntrada");
  cont.innerHTML = `
    <div class="gb-texto animarEntrada">
      <div class="gb-mes">üìÖ ${mesUpper}</div>
      <div class="gb-item">üîπ ${itemFormat}</div>
      <div class="gb-datos">
        üí∞ Ingresos: ${ingresos.toLocaleString("es-CL")}<br>
        üõí Gastos: ${gastos.toLocaleString("es-CL")}<br>
        üßÆ Saldo: ${saldo.toLocaleString("es-CL")}
      </div>
    </div>
  `;
}

// ‚úÖ Mantiene l√≥gica original sin tocar comportamiento
function ejecutarResetSaldo() {
  const mes = document.getElementById("mesSelect").value;
  const item = document.getElementById("itemSelect").value;

  if (!mes || !item) {
    mostrarAlertaFuturista("‚ö†Ô∏è Selecciona mes e √≠tem.");
    return;
  }

  cargarDetalleItem(mes, item, true);
}


/**
 * üìÇ Obtener todas las boletas de un mes
 */
function obtenerBoletasMes(mes, sheetId, carpetaId) {
  try {
    const folder = DriveApp.getFolderById(carpetaId || CARPETA_ID_GLOBAL);
    const files = folder.getFiles();
    const resultados = [];

    while (files.hasNext()) {
      const file = files.next();
      const nombre = file.getName();

      // Buscar boletas que contengan el nombre del mes en su t√≠tulo
      if (nombre.includes(mes)) {
        resultados.push({
          id: file.getId(),
          nombre: nombre,
          url: "https://drive.google.com/uc?export=view&id=" + file.getId()
        });
      }
    }

    return JSON.stringify(resultados);

  } catch (e) {
    return JSON.stringify({ error: e.message });
  }
}

/**
 * üìÇ Obtener URL de previsualizaci√≥n de una boleta
 */
function obtenerUrlBoleta(fileId) {
  try {
    return "https://drive.google.com/uc?export=view&id=" + fileId;
  } catch (e) {
    return "ERROR: " + e.message;
  }
}

/**
 * üìß Enviar una boleta al correo del usuario
 */
function descargarBoleta(fileId, correoDestino) {
  try {
    const file = DriveApp.getFileById(fileId);
    MailApp.sendEmail({
      to: correoDestino,
      subject: "üìÑ Boleta seleccionada",
      body: "Adjunto la boleta que seleccionaste.",
      attachments: [file.getAs(MimeType.PDF)]
    });
    return "OK";
  } catch (e) {
    return "ERROR: " + e.message;
  }
}

/**
 * üì¶ Descargar todas las boletas de un mes en un ZIP y enviar al correo
 */
function descargarTodasBoletas(mes, correoDestino, carpetaId) {
  try {
    const folder = DriveApp.getFolderById(carpetaId || CARPETA_ID_GLOBAL);
    const files = folder.getFiles();
    const blobs = [];

    while (files.hasNext()) {
      const file = files.next();
      if (file.getName().includes(mes)) {
        blobs.push(file.getBlob());
      }
    }

    if (blobs.length === 0) {
      return "No se encontraron boletas para " + mes;
    }

    // Crear ZIP temporal
    const zip = Utilities.zip(blobs, "Boletas_" + mes + ".zip");

    MailApp.sendEmail({
      to: correoDestino,
      subject: "üì¶ Boletas del mes " + mes,
      body: "Adjunto todas las boletas del mes seleccionado.",
      attachments: [zip]
    });

    return "OK";

  } catch (e) {
    return "ERROR: " + e.message;
  }
}


// üïí Abrir modal de recordatorio
function abrirModalRecordatorio() {
  document.getElementById("recordatorio-modal").style.display = "flex";
}

// üíæ Guardar recordatorio avanzado (texto + fecha + hora + duraci√≥n + repetici√≥n)
function guardarRecordatorioProgramado() {
  const texto = (document.getElementById("recordatorioTexto").value || "").trim();
  const fecha = document.getElementById("recordatorioFecha").value;
  const hora = document.getElementById("recordatorioHora").value;
  const duracion = parseInt(document.getElementById("recordatorioDuracion").value) || 5;
  const repetir = document.getElementById("recordatorioRepetir").value;
  const usuario = (localStorage.getItem("userName") || "").trim();
  const sheetId = localStorage.getItem("sheetId") || "";

  if (!texto || !fecha || !hora) {
    mostrarAlertaFuturista("‚ö†Ô∏è Complete todos los campos obligatorios.");
    return;
  }

  // Convertir fecha y hora a milisegundos
  const inicio = new Date(`${fecha}T${hora}:00`).getTime();
  const fin = inicio + duracion * 60 * 1000;
  const nuevo = { texto, inicio, fin, repetir };

  // ‚úÖ Guardar en localStorage (compatibilidad)
  const lista = JSON.parse(localStorage.getItem("recordatoriosProgramados") || "[]");
  lista.push(nuevo);
  localStorage.setItem("recordatoriosProgramados", JSON.stringify(lista));

    // ‚úÖ Guardar tambi√©n en la hoja "RECORDATORIOS"
  google.script.run
    .withSuccessHandler(resp => {
      if (resp === "OK") {
        mostrarAlertaFuturista("‚úÖ Recordatorio guardado correctamente");
        cerrarModal("recordatorio-modal");
        cargarPantallaResumenLED();
      } else {
        mostrarAlertaFuturista("‚ö†Ô∏è Error al guardar: " + resp);
      }
    })
    .guardarRecordatorioEnHoja(texto, fecha, hora, duracion, repetir, sheetId, usuario);

  // Limpieza de campos
  ["recordatorioTexto","recordatorioFecha","recordatorioHora","recordatorioDuracion"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
  document.getElementById("recordatorioRepetir").value = "ninguno";



  // refrescar LED resumen
  cargarPantallaResumenLED();
}


// üìÖ Devolver el texto del recordatorio ACTIVO seg√∫n fecha/hora actual y su repetici√≥n
function obtenerRecordatorioActivo() {
  const lista = JSON.parse(localStorage.getItem("recordatoriosProgramados") || "[]");
  const ahora = Date.now();

  for (let rec of lista) {
    // no repetici√≥n: v√°lido solo entre inicio y fin
    if (rec.repetir === "ninguno") {
      if (ahora >= rec.inicio && ahora <= rec.fin) return rec.texto;
      continue;
    }

    // repetici√≥n diaria: usar la hora guardada, cada d√≠a
    if (rec.repetir === "diario") {
      const hoy = new Date();
      const horaGuardada = new Date(rec.inicio);
      const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(),
                                 horaGuardada.getHours(), horaGuardada.getMinutes()).getTime();
      const finHoy = inicioHoy + (rec.fin - rec.inicio);
      if (ahora >= inicioHoy && ahora <= finHoy) return rec.texto;
      continue;
    }

    // repetici√≥n semanal: mismo d√≠a de la semana + misma hora
    if (rec.repetir === "semanal") {
      const hoy = new Date();
      const guardado = new Date(rec.inicio);
      if (hoy.getDay() === guardado.getDay()) {
        const inicioSem = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(),
                                   guardado.getHours(), guardado.getMinutes()).getTime();
        const finSem = inicioSem + (rec.fin - rec.inicio);
        if (ahora >= inicioSem && ahora <= finSem) return rec.texto;
      }
      continue;
    }
  }

  return "";
}

// üõë Eliminar o detener el recordatorio actualmente activo
function eliminarRecordatorioActivo() {
  const lista = JSON.parse(localStorage.getItem("recordatoriosProgramados") || "[]");
  const ahora = Date.now();
  const usuario = (localStorage.getItem("userName") || "").trim();
  const sheetId = localStorage.getItem("sheetId") || "";

  // Detectar el recordatorio que est√° activo ahora
  let indiceActivo = -1;
  let recActivo = null;
  for (let i = 0; i < lista.length; i++) {
    const rec = lista[i];
    if (ahora >= rec.inicio && ahora <= rec.fin) {
      indiceActivo = i;
      recActivo = rec;
      break;
    }
  }

  if (indiceActivo === -1) {
    mostrarAlertaFuturista("‚ö†Ô∏è No hay recordatorio activo para detener.");
    return;
  }

  // Eliminar del localStorage
  lista.splice(indiceActivo, 1);
  localStorage.setItem("recordatoriosProgramados", JSON.stringify(lista));

  // Eliminar de la hoja del usuario
  google.script.run.withSuccessHandler(resp => {
    if (resp === "OK") {
      mostrarAlertaFuturista("üõë Recordatorio eliminado.");
    } else {
      mostrarAlertaFuturista("‚ö†Ô∏è Error al eliminar: " + resp);
    }
    cargarPantallaResumenLED();
  }).eliminarRecordatorioDeHoja(recActivo.texto, usuario, sheetId);
}

function actualizarBotonRecordatorio(estadoVisible) {
  const boton = document.getElementById("boton-detener-recordatorio");
  if (!boton) return;
  boton.style.display = estadoVisible ? "block" : "none";
}


// üîπ Nueva pantalla LED: Resumen + Recordatorio (todo junto en una sola l√≠nea)
function cargarPantallaResumenLED() {
  const usuario = (localStorage.getItem("userName") || "").trim();
  const sheetId = localStorage.getItem("sheetId") || "";
  if (!usuario || !sheetId) return;

  const ahora = new Date();
  const fechaStr = ahora.toLocaleDateString('es-CL', { day: '2-digit', month: 'short', year: 'numeric' });
  const horaStr = ahora.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const mesNombre = ahora.toLocaleString('es-CL', { month: 'long' });
  const mesCap = mesNombre.charAt(0).toUpperCase() + mesNombre.slice(1);

  const recordatorio = obtenerRecordatorioActivo();

  // üí° NUEVO: Secci√≥n del usuario y t√≠tulo del resumen (Texto en blanco)
  // Utilizamos 'texto-recordatorio' y forzamos el estilo para asegurar el color blanco.
  const textoUsuarioYTitulo = `
    <span class="texto-recordatorio" style="margin-left:0; color:#ffffff !important; text-shadow:none !important;">${usuario} | üí∞ Resumen del mes</span>
  `;

  // üîπ Llamada al backend para obtener datos financieros del mes actual
  google.script.run.withSuccessHandler(resumen => {
    const led = document.getElementById("ledResumenContent");
    if (!led) return;

    // ‚úÖ Convertir ingresos y egresos a formato de n√∫mero chileno
    const ingresos = resumen?.ingresos && !isNaN(resumen.ingresos)
      ? Number(resumen.ingresos).toLocaleString("es-CL")
      : "0";
    const egresos = resumen?.egresos && !isNaN(resumen.egresos)
      ? Number(resumen.egresos).toLocaleString("es-CL")
      : "0";

    // üîπ Construir texto base del resumen (el detalle, que asumo tiene otro color)
    let textoBaseDetalle = `
      <span class="texto-resumen">
        | üïì ${horaStr} | üìÖ ${fechaStr} (${mesCap}) |
        üíµ Ingresos: $${ingresos} | üí∏ Egresos: $${egresos}
      </span>
    `;

    // üîπ Si no hay movimientos, se muestra un mensaje simple
    if (ingresos === "0" && egresos === "0") {
      // El formato de la hora y fecha se mantiene, solo cambia el mensaje de finanzas
      textoBaseDetalle = `
        <span class="texto-resumen">
          | üïì ${horaStr} | üìÖ ${fechaStr} (${mesCap}) | A√∫n no hay movimientos registrados üí∞
        </span>
      `;
    }

    // üîπ Unir el nombre de usuario/t√≠tulo con el detalle financiero
    let textoFinal = textoUsuarioYTitulo + textoBaseDetalle;


    // üîπ Agregar el recordatorio al final (solo si existe)
    if (recordatorio) {
      // El recordatorio se mantiene con su estilo original, agregando el emoji üìù
      textoFinal += `
        <span class="texto-recordatorio"> | üìù ${recordatorio}</span>
      `;
      actualizarBotonRecordatorio(true);
    } else {
      actualizarBotonRecordatorio(false);
    }

    // üîπ Mostrar el texto completo en el LED
    led.innerHTML = textoFinal;
  }).obtenerResumenFinanciero(mesCap, sheetId);
}

// ‚è±Ô∏è Actualiza cada 5 segundos
setInterval(cargarPantallaResumenLED, 5000);
document.addEventListener("DOMContentLoaded", cargarPantallaResumenLED);




function actualizarBotonRecordatorio(estadoVisible) {
  const boton = document.getElementById("boton-detener-recordatorio");
  if (!boton) return;
  boton.style.display = estadoVisible ? "block" : "none";
}

// üì§ Sincroniza recordatorios desde la hoja "RECORDATORIOS" al localStorage al iniciar sesi√≥n
function sincronizarRecordatoriosDesdeHoja() {
  const usuario = (localStorage.getItem("userName") || "").trim();
  const sheetId = localStorage.getItem("sheetId") || "";

  // ‚ö†Ô∏è Verificaci√≥n antes de hacer la llamada al backend
  if (!usuario || !sheetId) return;

  google.script.run.withSuccessHandler(lista => {
    if (!lista || lista.length === 0) return;
    localStorage.setItem("recordatoriosProgramados", JSON.stringify(lista));
    console.log("‚úÖ Recordatorios sincronizados desde hoja:", lista.length);
  }).obtenerRecordatoriosDeUsuario(sheetId, usuario);
}

// üîπ Funci√≥n para actualizar la pantalla LED Resumen con color especial para recordatorios
function actualizarPantallaResumen(texto, esRecordatorio = false) {
  const ledResumen = document.getElementById("ledResumenContent");
  if (!ledResumen) return;

  // ‚úÖ Si es recordatorio, se muestra en blanco brillante
  if (esRecordatorio) {

    ledResumen.innerHTML = `<span class="recordatorio">${texto}</span>`;
  } else {
    ledResumen.textContent = texto;
  }
}


// üîπ Permite pausar el desplazamiento global del LED (scroll) al hacer clic fuera del video
document.getElementById("indicadores").addEventListener("click", (e) => {
  const videoLED = document.getElementById("videoLED");
  const ledSpan = document.querySelector("#indicadores span");

  // Solo si existe un video dentro del LED
  if (videoLED && e.target.id !== "videoLED") {
    const currentState = ledSpan.style.animationPlayState || "running";
    const newState = currentState === "running" ? "paused" : "running";
    ledSpan.style.animationPlayState = newState;
  }
});


// üîâ Activar audio autom√°ticamente en el primer clic dentro del LED (volumen medio)
document.getElementById("indicadores").addEventListener("click", () => {
  const videoLED = document.getElementById("videoLED");
  if (videoLED && videoLED.muted) {
    videoLED.muted = false;
    videoLED.volume = 0.5; // volumen al 50%
  }
}, { once: true }); // se ejecuta una sola vez


  // Normalizador universal (ignora may√∫sculas, tildes y espacios)
  function norm(txt) {
    return (txt || "")
      .toString()
      .normalize("NFD")
      .replace(/\p{Diacritic}/gu, "")
      .replace(/\s+/g, " ")
      .trim()
      .toUpperCase();
  }

  // Tiempo m√°ximo de vida del cach√© (en milisegundos)
  const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

  document.addEventListener("DOMContentLoaded", () => {
    const usuario = localStorage.getItem("userName") || "";
    if (!usuario) return;

    // ‚ö° Ocultamos todos los botones brevemente al inicio
    document.querySelectorAll("button, .btn, .boton").forEach(btn => {
      btn.style.opacity = "0";
      btn.style.transition = "opacity 0.3s ease";
    });

    const cacheKey = `botonesVisibles_cache_${usuario}`;
    const cacheData = localStorage.getItem(cacheKey);
    let usarCache = false;

    if (cacheData) {
      try {
        const { configurados, visibles, timestamp } = JSON.parse(cacheData);
        // Verificamos si el cach√© a√∫n no ha expirado
        if (Date.now() - (timestamp || 0) < CACHE_DURATION) {
          usarCache = true;
          aplicarReglasDeBotones(configurados, visibles, true);
        }
      } catch (e) {
        console.warn("Error leyendo cach√© de botones:", e);
      }
    }

    // üåÄ Actualizamos siempre desde el servidor (aunque haya cach√©)
    google.script.run
      .withSuccessHandler(({ configurados, visibles }) => {
        aplicarReglasDeBotones(configurados, visibles, false);
        localStorage.setItem(
          cacheKey,
          JSON.stringify({ configurados, visibles, timestamp: Date.now() })
        );
      })
      .obtenerBotonesConfigYVisibles(usuario);

    // Si no hab√≠a cach√©, mostramos los botones tras 300 ms
    if (!usarCache) {
      setTimeout(() => {
        document.querySelectorAll("button, .btn, .boton").forEach(btn => {
          btn.style.opacity = "1";
        });
      }, 300);
    }
  });

  function aplicarReglasDeBotones(configurados, visibles, desdeCache = false) {
    if (!Array.isArray(configurados) || configurados.length === 0) {
      document.querySelectorAll("button, .btn, .boton").forEach(btn => {
        btn.style.opacity = "1";
      });
      return;
    }

    const setConfigurados = new Set(configurados.map(norm));
    const setVisibles = new Set(visibles.map(norm));

    document.querySelectorAll("button, .btn, .boton").forEach(btn => {
      const texto = norm(btn.textContent || btn.innerText);
      if (setConfigurados.has(texto)) {
        btn.style.display = setVisibles.has(texto) ? "" : "none";
      } else {
        btn.style.display = ""; // visible si no est√° listado en la hoja
      }
      setTimeout(() => { btn.style.opacity = "1"; }, 200);
    });
  }

 // ‚úÖ Cargar din√°micamente el video del container seg√∫n hoja "Videos"
document.addEventListener("DOMContentLoaded", () => {
  const usuarioActual = localStorage.getItem("nombreUsuario") || "";
  const videoContainer = document.getElementById("videoContainer");
  const videoElement = document.getElementById("videoPublicidad");
  const source = document.getElementById("videoSource");

  // ‚¨á‚¨á‚¨á NUEVO: si la estructura esperada no existe, no hacemos nada
  if (!videoContainer || !videoElement || !source) {
    return;
  }

  google.script.run
    .withSuccessHandler(data => {
      if (!data || !data.url) {
        videoContainer.style.display = "none";
        return;
      }

      const reglas = (data.reglas || "").split(",").map(x => x.trim().toLowerCase());
      const nombre = usuarioActual.trim().toLowerCase();

      const visibleParaTodos = !reglas || reglas.length === 0 || reglas[0] === "";
      const permitido = visibleParaTodos || reglas.includes(nombre);

      if (permitido) {
        source.src = data.url;
        videoContainer.style.display = "flex";
        videoElement.load();
        videoElement.play().catch(() => {});
      } else {
        videoContainer.style.display = "none";
      }
    })
    .getVideoContainerData();
});


// ‚úÖ Anti-Freeze ‚Ä¢ Mantener vivo el reproductor del CONTENEDOR
function protegerStreaming() {
  const video = document.getElementById("videoPublicidad");
  const iframe = document.getElementById("livePlayer");

  // ‚¨á‚¨á‚¨á NUEVO: si no existe ninguno de los dos, no hacemos nada
  if (!video && !iframe) {
    return;
  }

  setInterval(() => {
    // üé• Si est√° mostrando video MP4/HLS
    if (video && video.style.display !== "none") {
      if (video.paused || video.readyState < 2) {
        video.play().catch(()=>{});
      }
    }

    // üì∫ Si est√° en modo streaming (iframe)
    if (iframe && iframe.style.display !== "none") {
      // Reload invisible del iframe cada 15 minutos para evitar pantalla gris
      if (!iframe.dataset.tiempo) {
        iframe.dataset.tiempo = Date.now();
      }
      if (Date.now() - iframe.dataset.tiempo > 900000) { // 15 minutos
        const src = iframe.src;
        iframe.src = ""; setTimeout(()=> iframe.src = src, 500);
        iframe.dataset.tiempo = Date.now();
      }
    }

  }, 5000); // ‚úÖ Revisa cada 5 segundos
}

// üöÄ Ejecutar cuando la p√°gina est√© lista
document.addEventListener("DOMContentLoaded", protegerStreaming);



function reproducirVideo(url) {
  const video = document.getElementById("videoPlayer");

  if (!url) {
    video.style.display = "none";
    return;
  }

  video.style.display = "block";

  // Si es streaming HLS (.m3u8)
  if (url.includes(".m3u8")) {
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
    } else {
      video.src = url;
    }
  } else {
    // Si es MP4 u otro formato
    video.src = url;
  }
}
  // Registrar service worker servido por Apps Script
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('?page=service-worker.js')
        .then(reg => console.log('Service Worker registrado:', reg.scope))
        .catch(err => console.warn('Error registrando SW:', err));
    });
  } else {
    console.log('Service Worker no soportado en este navegador.');
  }


function forzarAutoplay(video) {
  let intentos = 0;
  const intentar = () => {
    video.muted = true;
    const p = video.play();
    if (p) {
      p.catch(() => {
        if (intentos < 15) {
          intentos++;
          setTimeout(intentar, 200);
        }
      });
    }
  };
  intentar();
}

document.addEventListener("DOMContentLoaded", () => {
  const videoContenedor = document.getElementById("video-contenedor");

  if (!videoContenedor) return;

  videoContenedor.muted = true;
  videoContenedor.autoplay = false;
  videoContenedor.controls = true;

  let usuarioActivoVideoContenedor = false;

  document.addEventListener("click", (e) => {

    // Si hacen click dentro de la pantalla LED ‚Üí NO activar sonido del contenedor
    if (e.target.id === "videoLED" || e.target.closest("#videoLED-container")) {
      return;
    }

    // Si hacen click afuera del LED ‚Üí activar sonido del contenedor
    if (!usuarioActivoVideoContenedor) {
      usuarioActivoVideoContenedor = true;
      videoContenedor.muted = false;
      videoContenedor.play().catch(()=>{});
    }
  });

  // Si el usuario pausa manualmente ‚Üí no reanudar jam√°s autom√°tico
  videoContenedor.addEventListener("pause", () => {
    usuarioActivoVideoContenedor = true;
  });
});




document.addEventListener("DOMContentLoaded", () => {
  sincronizarRecordatoriosDesdeHoja();
  cargarEstilos();
});


  // üîí Bloquear zoom en m√≥viles
  document.addEventListener('gesturestart', e => e.preventDefault());
  document.addEventListener('gesturechange', e => e.preventDefault());
  document.addEventListener('gestureend', e => e.preventDefault());

  // üîí Bloquear doble toque (zoom por doble tap)
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  // üîí Bloquear zoom con Ctrl + scroll o gestos del navegador
  document.addEventListener('wheel', function (e) {
    if (e.ctrlKey) e.preventDefault();
  }, { passive: false });

  // üîí En algunos navegadores, bloquear el gesto de pinza por completo
  document.addEventListener('touchmove', function (e) {
    if (e.scale !== undefined && e.scale !== 1) {
      e.preventDefault();
    }
  }, { passive: false });

// üîí Bloqueo de clic derecho y teclas de inspecci√≥n
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  const key = e.key || e.keyCode;
  if (
    key === 'F12' ||
    (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(String(key).toUpperCase())) ||
    (e.ctrlKey && String(key).toUpperCase() === 'U')
  ) {
    e.preventDefault();
  }
});



document.addEventListener("DOMContentLoaded", () => {
    const usuario = sessionStorage.getItem("usuarioActual") || "";
    if (!usuario) return;
    
    google.script.run
      .withSuccessHandler(mostrarLogosInstalados)
      .obtenerLogosInstalados(usuario, "INDEX");
  });

  function mostrarLogosInstalados(data) {
    if (!data || data.length === 0) return;

    const contenedor = document.getElementById("logo-index");
    if (!contenedor) return;

    const ultimo = data[data.length - 1];  // √∫ltimo logo instalado para INDEX
    contenedor.innerHTML = `<img src="${ultimo.url}" style="width:100%;height:auto;">`;
  }



  // Bloquear gestos de zoom en iOS (gesturestart / change / end)
  document.addEventListener('gesturestart', function (e) {
    e.preventDefault();
  }, { passive: false });

  document.addEventListener('gesturechange', function (e) {
    e.preventDefault();
  }, { passive: false });

  document.addEventListener('gestureend', function (e) {
    e.preventDefault();
  }, { passive: false });

  // Bloquear zoom con ctrl + scroll (algunos Android / navegadores de escritorio)
  document.addEventListener('wheel', function (e) {
    if (e.ctrlKey) {
      e.preventDefault();
    }
  }, { passive: false });


document.addEventListener("visibilitychange", function () {

// ‚úÖ Guardar estado al minimizar / ocultar (solo para MP4 del videoPlayer)
if (document.hidden) {
  try {
    const videoPlayer = document.getElementById("videoPlayer");
    const source = document.getElementById("videoSource");

    if (videoPlayer && videoPlayer.style.display !== "none") {
      const src = (source && source.src) ? source.src : (videoPlayer.currentSrc || "");
      const st = {
        src,
        t: videoPlayer.currentTime || 0,
        paused: videoPlayer.paused
      };
      sessionStorage.setItem("estadoVideoPlayer", JSON.stringify(st));
    }
  } catch(e) {}
  return; // üëà importante: si est√° oculta, salimos y no hacemos ‚Äúreinicios‚Äù
}


  // Si volvemos a la app
  if (!document.hidden) {

    // üü¶ 1. Reiniciar VIDEO LED superior
    try {
      const videoLED = document.getElementById("videoLED");
      if (videoLED) {
        videoLED.pause();
        videoLED.load();   // recargar fuente
        videoLED.play().catch(()=>{}); // intentar reproducir sin error
      }
    } catch(e) { console.log("Error recuperando LED:", e); }

    // üü© 2. Reiniciar video principal del contenedor
    // ‚úÖ Mantener MP4 pausado al minimizar (NO hacer load aqu√≠)
try {
  const videoPlayer = document.getElementById("videoPlayer");
  const source = document.getElementById("videoSource");

  if (videoPlayer && videoPlayer.style.display !== "none") {
    // Si hay un estado guardado, lo restauramos
    const raw = sessionStorage.getItem("estadoVideoPlayer");
    if (raw) {
      const st = JSON.parse(raw);

      // Solo aplica si el src coincide (mismo MP4)
      const actualSrc = (source && source.src) ? source.src : (videoPlayer.currentSrc || "");
      if (st.src && actualSrc && st.src === actualSrc) {

        // Restaurar tiempo cuando haya metadata lista
        const aplicar = () => {
          try {
            // Evita NaN
            if (Number.isFinite(st.t)) videoPlayer.currentTime = st.t;
            if (st.paused) {
              videoPlayer.pause(); // mantener pausado
            } else {
              videoPlayer.play().catch(()=>{});
            }
          } catch(e) {}
        };

        if (videoPlayer.readyState >= 1) {
          aplicar();
        } else {
          videoPlayer.addEventListener("loadedmetadata", aplicar, { once: true });
        }
      }
    }
  }
} catch(e) {
  console.log("Error restaurando estado videoPlayer:", e);
}


    // üüß 3. Reiniciar HLS.js si se usa streaming .m3u8
    try {
  if (window.hlsInstance) {
    const currentUrl = window.hlsInstance.url;
    const videoPlayer = document.getElementById("videoPlayer");

    window.hlsInstance.destroy();
    window.hlsInstance = new Hls();
    window.hlsInstance.loadSource(currentUrl);

    if (videoPlayer) {
      window.hlsInstance.attachMedia(videoPlayer);
      videoPlayer.play().catch(()=>{});
    }
  }
} catch(e) {
  console.log("Error reiniciando HLS:", e);
}


    // üü• 4. Si es iframe (YouTube / Twitch), forzar recarga
    const iframe = document.getElementById("iframePlayer");
    if (iframe && iframe.style.display !== "none") {
      const src = iframe.src;
      iframe.src = "";     // reset
      setTimeout(() => { iframe.src = src; }, 300);
    }

  }
});



// ============================================================
// üîπ CONTROL AUTOM√ÅTICO DE INACTIVIDAD (index.html)
// ============================================================

let tiempoInactividadMs = 0;
let temporizadorInactividad = null;
// üîÅ NUEVO: intervalo que revisa en segundo plano
let intervaloChequeoInactividad = null;

// üîë Clave en localStorage para guardar el ‚Äúmomento de expiraci√≥n‚Äù
const CLAVE_LS_EXPIRA_INACTIVIDAD = "expiraSesionInactividad";

/**
 * Inicializa el control de inactividad:
 * - Pide a Apps Script los minutos configurados en INACTIVIDAD USUARIO!A2
 * - Si es > 0, activa el contador, listeners y chequeo peri√≥dico
 */
function inicializarControlInactividad() {
  const usuario = (localStorage.getItem("userName") || "").trim();
  if (!usuario) {
    // Si no hay usuario logueado, no tiene sentido controlar inactividad
    return;
  }

  // üßπ Limpieza por si qued√≥ algo de otra sesi√≥n
  try {
    localStorage.removeItem(CLAVE_LS_EXPIRA_INACTIVIDAD);
  } catch (e) {
    console.warn("No se pudo limpiar expiraci√≥n vieja de inactividad:", e);
  }

  google.script.run
    .withSuccessHandler(function (minutos) {
      try {
        console.log("‚è±Ô∏è Valor crudo recibido desde Apps Script (A2):", minutos);

        let m = Number(minutos);

        // üîç Caso especial: A2 escrito como HORA (ej: 0:05:00)
        // Sheets lo entrega como fracci√≥n de d√≠a (ej: 0.00347)
        if (m > 0 && m < 1) {
          m = m * 24 * 60; // d√≠as ‚Üí minutos
          console.log("üîÅ A2 ven√≠a como fracci√≥n de d√≠a. Convertido a minutos reales:", m);
        }

        if (!m || !isFinite(m) || m <= 0) {
          console.log("‚è±Ô∏è Control de inactividad desactivado (valor vac√≠o o 0).");
          return;
        }

        tiempoInactividadMs = m * 60 * 1000;
        console.log("‚è±Ô∏è Control de inactividad ACTIVO. Minutos:", m, "‚Üí Milisegundos:", tiempoInactividadMs);

        configurarListenersInactividad();
        // üëâ Al iniciar, revisamos si ya estaba vencida la sesi√≥n
        verificarInactividadAlVolver();
        // üëâ Y arrancamos el chequeo en segundo plano
        iniciarChequeoPeriodicoInactividad();
      } catch (e) {
        console.warn("Error al iniciar control de inactividad:", e);
      }
    })
    .obtenerTiempoInactividadMinutos(); // üöÄ funci√≥n en Code.gs
}

/**
 * Registra eventos que cuentan como "actividad":
 * - click, teclado, touch
 * - minimizar / cambiar pesta√±a / cambiar app
 * - bloquear pantalla del celular, etc.
 */
function configurarListenersInactividad() {
  const registrarActividadLocal = () => {
    reiniciarTemporizadorInactividad();
  };

  // Solo eventos claramente generados por el usuario
  const eventos = [
    "mousedown",
    "keydown",
    "touchstart",
    "touchmove"
  ];

  eventos.forEach(ev => {
    window.addEventListener(ev, registrarActividadLocal, { passive: true });
  });

  // üîµ P√°gina oculta ‚Üí minimizar, cambiar pesta√±a, cambiar app
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      console.log("üì¥ P√°gina oculta ‚Üí comenzando temporizador de inactividad");
      reiniciarTemporizadorInactividad();
    } else {
      console.log("üì± P√°gina visible nuevamente ‚Üí verificar si ya venci√≥");
      verificarInactividadAlVolver();
    }
  });

  // üîµ Ventana pierde foco (cambiar de app, abrir otra pesta√±a, etc.)
  window.addEventListener("blur", () => {
    console.log("üîï Ventana perdi√≥ el foco ‚Üí comenzando temporizador");
    reiniciarTemporizadorInactividad();
  });

  // üîµ Ventana vuelve a foco
  window.addEventListener("focus", () => {
    console.log("üîî Ventana volvi√≥ a foco ‚Üí verificar si ya venci√≥");
    verificarInactividadAlVolver();
  });

  // üîµ Cuando el navegador dispara pagehide (muy t√≠pico al BLOQUEAR pantalla en m√≥viles)
  window.addEventListener("pagehide", () => {
    console.log("üìµ 'pagehide' ‚Üí posible bloqueo de pantalla o cierre temporal");
    reiniciarTemporizadorInactividad();
  });

  // üîµ Cuando vuelve desde el historial / cach√© (m√≥vil Safari, etc.)
  window.addEventListener("pageshow", () => {
    console.log("üì≤ 'pageshow' ‚Üí revisando inactividad al volver");
    verificarInactividadAlVolver();
  });
}

/**
 * üîÅ NUEVO:
 * Chequeo peri√≥dico en segundo plano (cada pocos segundos)
 * para que en el CELULAR no tengas que hacer click al volver.
 */
function iniciarChequeoPeriodicoInactividad() {
  if (!tiempoInactividadMs) return;

  // Limpiar si ya hab√≠a uno
  if (intervaloChequeoInactividad) {
    clearInterval(intervaloChequeoInactividad);
    intervaloChequeoInactividad = null;
  }

  // Intervalo fijo de MEDIO segundo (puedes subirlo si quieres menos frecuencia)
  intervaloChequeoInactividad = setInterval(() => {
    comprobarExpiracionSilenciosa();
  }, 500);
}

function detenerChequeoPeriodicoInactividad() {
  if (intervaloChequeoInactividad) {
    clearInterval(intervaloChequeoInactividad);
    intervaloChequeoInactividad = null;
  }
}

/**
 * üîç NUEVO:
 * Revisa SOLO si el tiempo ya venci√≥, SIN reiniciar el temporizador.
 * As√≠ no se "corre" la hora de expiraci√≥n al hacer el chequeo.
 */
function comprobarExpiracionSilenciosa() {
  if (!tiempoInactividadMs) return;

  try {
    const valor = localStorage.getItem(CLAVE_LS_EXPIRA_INACTIVIDAD);
    const expira = valor ? parseInt(valor, 10) : 0;
    const ahora = Date.now();

    if (expira && ahora >= expira) {
      console.log("‚è∞ Inactividad detectada por chequeo peri√≥dico (sin interacci√≥n).");
      manejarInactividadDetectada();
    }
  } catch (e) {
    console.warn("Error en chequeo peri√≥dico de inactividad:", e);
  }
}

/**
 * Reinicia el temporizador de inactividad.
 * - Actualiza el timeout en memoria
 * - Y guarda en localStorage el momento exacto en que debe EXPIRAR la sesi√≥n
 */
function reiniciarTemporizadorInactividad() {
  if (!tiempoInactividadMs) return;

  if (temporizadorInactividad) {
    clearTimeout(temporizadorInactividad);
  }

  const ahora = Date.now();
  const expiraEn = ahora + tiempoInactividadMs;

  try {
    localStorage.setItem(CLAVE_LS_EXPIRA_INACTIVIDAD, String(expiraEn));
  } catch (e) {
    console.warn("No se pudo guardar expiraci√≥n de inactividad en localStorage:", e);
  }

  temporizadorInactividad = setTimeout(() => {
    manejarInactividadDetectada();
  }, tiempoInactividadMs);

  // Nos aseguramos de que el chequeo peri√≥dico est√© activo
  iniciarChequeoPeriodicoInactividad();
}

/**
 * Verifica, usando el reloj REAL (Date.now),
 * si ya se pas√≥ el tiempo guardado en localStorage.
 * - Si ya pas√≥ ‚Üí cierra sesi√≥n de inmediato.
 * - Si no ‚Üí simplemente reinicia el temporizador.
 */
function verificarInactividadAlVolver() {
  if (!tiempoInactividadMs) return;

  try {
    const valor = localStorage.getItem(CLAVE_LS_EXPIRA_INACTIVIDAD);
    const expira = valor ? parseInt(valor, 10) : 0;
    const ahora = Date.now();

    if (expira && ahora >= expira) {
      console.log("‚è∞ Inactividad detectada al volver (focus / desbloqueo / reload).");
      manejarInactividadDetectada();
    } else {
      // No ha pasado el tiempo a√∫n ‚Üí seguimos como siempre
      reiniciarTemporizadorInactividad();
    }
  } catch (e) {
    console.warn("Error verificando inactividad al volver:", e);
    reiniciarTemporizadorInactividad();
  }
}

/**
 * Cuando se cumple el tiempo de inactividad:
 * - Intenta registrar al usuario como OFFLINE (no bloqueante)
 * - Cierra la sesi√≥n reutilizando cerrarSesion()
 * - Si algo falla, redirige igual al login
 */
function manejarInactividadDetectada() {
  try {
    // Detenemos cualquier timer que quede vivo
    if (temporizadorInactividad) {
      clearTimeout(temporizadorInactividad);
      temporizadorInactividad = null;
    }
    detenerChequeoPeriodicoInactividad();

    // üßπ Limpiamos el valor de expiraci√≥n para esta sesi√≥n
    try {
      localStorage.removeItem(CLAVE_LS_EXPIRA_INACTIVIDAD);
    } catch (e) {
      console.warn("No se pudo limpiar expiraci√≥n de inactividad al cerrar sesi√≥n:", e);
    }

    const usuario =
      (localStorage.getItem("usuarioActivo") ||

        localStorage.getItem("userName") ||
        "").trim();

    console.log("‚è∞ Inactividad detectada. Usuario:", usuario || "(vac√≠o)");

    if (usuario) {
      try {
        google.script.run.registrarOffline(usuario);
      } catch (e) {
        console.warn("No se pudo registrar OFFLINE por inactividad:", e);
      }
    }

    try {
      if (typeof mostrarAlerta === "function") {
        mostrarAlerta("‚è∞ Tu sesi√≥n se cerr√≥ por inactividad.");
      }
    } catch (e) {
      console.warn("Error mostrando alerta de inactividad:", e);
    }

    cerrarSesion();
  } catch (e) {
    console.error("Error en manejarInactividadDetectada:", e);
    try {
      const urlLogin = obtenerUrlLoginFinal();
      window.top.location.replace(urlLogin);
    } catch (e2) {
      console.error("Error redirigiendo al login tras inactividad:", e2);
    }
  }
}


// ‚úÖ Activar el control de inactividad cuando el DOM est√© listo
document.addEventListener("DOMContentLoaded", inicializarControlInactividad);

// ‚úÖ Esto ya lo ten√≠as: registrar actividad al cargar la p√°gina
(function() {
  const usuario = (localStorage.getItem("userName") || "").trim();
  if (usuario) {
    // Puedes pasar opcionalmente el nombre de la p√°gina
    google.script.run.registrarActividad(
      usuario,
      document.body.getAttribute("data-page") || ""
    );
  }
})();

  </script>


    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(() => console.log('‚úÖ Service Worker registrado'))
        .catch(err => console.error('‚ùå Error SW:', err));
    }
  </script>


</body>
</html>
